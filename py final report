import time
import sys
import json
import os
import textwrap
import re
import random
from colorama import init, Fore, Style

# --- é¡è‰²èˆ‡ UI ä¸»é¡Œè¨­å®š ---
colors = {"system": Fore.YELLOW, "girl": Fore.MAGENTA, "friend": Fore.CYAN, "stat_up": Fore.GREEN, "stat_down": Fore.RED, "scene": Fore.WHITE, "locked": Style.DIM + Fore.WHITE, "error": Fore.RED + Style.BRIGHT, "prompt": Fore.WHITE, "stat_name": Style.BRIGHT, "inventory": Fore.BLUE, "time": Fore.LIGHTBLUE_EX, "border": Style.DIM, "title": Fore.YELLOW + Style.BRIGHT, "stamina": Fore.GREEN}
BOX_CHARS = {"tl": "â•”", "tr": "â•—", "bl": "â•š", "br": "â•", "h": "â•", "v": "â•‘", "ts": "â•¤", "bs": "â•§", "ls": "â•Ÿ", "rs": "â•¢", "cs": "â•«"}

# --- å…¨åŸŸè¨­å®š ---
SAVE_FILE = "savegame.json"
PERIODS = ["ä¸Šåˆ", "ä¸‹åˆ", "æ™šä¸Š"]
STAMINA_RECOVERY_ON_SLEEP = 10 # æ™šä¸Šç¡è¦ºæ¢å¾©çš„é«”åŠ› (å·²é™ä½Ž)

# --- è¼”åŠ©å‡½å¼ï¼šè¨ˆç®—æ–‡å­—é¡¯ç¤ºå¯¬åº¦ (ä¸­æ–‡å­—ç®—2æ ¼) ---
def get_str_width(s):
    return sum(2 if ord(c) > 255 else 1 for c in s)

# --- UI ç¹ªè£½å‡½å¼ ---
def draw_box(title, content_lines, width):
    title_width = get_str_width(title)
    print(colors["border"] + BOX_CHARS["tl"] + BOX_CHARS["h"] * 2 + f" {colors['title']}{title}{colors['border']} " + BOX_CHARS["h"] * (width - title_width - 5) + BOX_CHARS["tr"] + Style.RESET_ALL)
    for line in content_lines:
        clean_line = re.sub(r'\x1b\[[0-9;]*m', '', line)
        visible_len = get_str_width(clean_line)
        padding = width - visible_len - 2
        padding = max(0, padding) # ç¢ºä¿ä¸æœƒæ˜¯è² æ•¸
        print(colors["border"] + BOX_CHARS["v"] + Style.RESET_ALL + f" {line}{' ' * padding}" + colors["border"] + BOX_CHARS["v"] + Style.RESET_ALL)
    print(colors["border"] + BOX_CHARS["bl"] + BOX_CHARS["h"] * (width - 2) + BOX_CHARS["br"] + Style.RESET_ALL)

def display_girl_profiles():
    term_width = os.get_terminal_size().columns
    os.system('cls' if os.name == 'nt' else 'clear')
    
    title = "äººç‰©è¨­å®š"
    lines = ["åœ¨éŠæˆ²é–‹å§‹å‰ï¼Œå…ˆä¾†èªè­˜ä¸€ä¸‹é€™å¹¾ä½è§’è‰²å§ï¼"]
    draw_box(title, lines, term_width)
    input(colors["prompt"] + "æŒ‰ä¸‹ Enter éµç¹¼çºŒ..." + Style.RESET_ALL)

    for girl in GIRL_PROFILES:
        os.system('cls' if os.name == 'nt' else 'clear')
        profile_lines = [
            f"å§“å: {girl['name']}",
            f"æ€§åˆ¥: {girl['gender']}",
            f"æè¿°: {girl['description']}",
            f"æ„›å¥½: {girl['hobbies']}",
            f"é‡è¦–: {girl['focus']}",
            f"å¸¸å‡ºæ²’åœ°é»ž: {girl['location']}"
        ]
        draw_box(f"{girl['name']} çš„å€‹äººæª”æ¡ˆ", profile_lines, term_width)
        input(colors["prompt"] + "æŒ‰ä¸‹ Enter éµæŸ¥çœ‹ä¸‹ä¸€ä½..." + Style.RESET_ALL)

    os.system('cls' if os.name == 'nt' else 'clear')
    draw_box("æº–å‚™é–‹å§‹éŠæˆ²", ["ä½ å·²é–±è®€å®Œæ‰€æœ‰è§’è‰²çš„è¨­å®šï¼Œæº–å‚™å¥½é–‹å§‹ä½ çš„å¤§å­¸æ ¡åœ’æ•…äº‹äº†å—Žï¼Ÿ"], term_width)
    input(colors["prompt"] + "æŒ‰ä¸‹ Enter éµé–‹å§‹éŠæˆ²..." + Style.RESET_ALL)

def prepare_state_lines(player, npcs):
    lines = []
    stamina_color = colors['stamina'] if player['stamina'] > 30 else colors['error']
    lines.append(f"ðŸ’ª {colors['stat_name']}é«”åŠ›:{Style.RESET_ALL} {stamina_color}{player.get('stamina', 0)}/{player.get('max_stamina', 100)}{Style.RESET_ALL} | ðŸ’° {colors['stat_name']}è²¡å¯Œ:{Style.RESET_ALL} {player['wealth']:<4}å…ƒ | ðŸŽ“ {colors['stat_name']}æ™ºæ…§:{Style.RESET_ALL} {round(player.get('intelligence', 0), 1)}")
    lines.append(f"âœ¨ {colors['stat_name']}é¡å€¼:{Style.RESET_ALL} {player['appearance']:<4} | ðŸ“ {colors['stat_name']}èº«é«˜:{Style.RESET_ALL} {player['height']:<4}cm")
    inventory_text = ', '.join(player['inventory']) if player['inventory'] else 'ç©º'
    lines.append(f"ðŸŽ’ {colors['stat_name']}èƒŒåŒ…:{Style.RESET_ALL} {colors['inventory']}{inventory_text}{Style.RESET_ALL}")
    lines.append(BOX_CHARS["ls"] + BOX_CHARS["h"]*3 + f" {Style.BRIGHT}äººç‰©é—œä¿‚{Style.NORMAL} " + BOX_CHARS["h"]*3 + BOX_CHARS["rs"])
    for girl_profile in GIRL_PROFILES:
        girl_key = girl_profile["key"]
        if girl_key in npcs:
            affection = npcs[girl_key]["affection"]
            # Use a default color for all girls for now, or define specific colors later
            lines.append(f"â¤ï¸  {colors['girl']}{girl_profile['name']} (å¥½æ„Ÿåº¦): {affection}{Style.RESET_ALL}")
    return lines

# --- å­˜æª”/è®€æª”åŠŸèƒ½ ---
def save_game(player, npcs, time, scene_id):
    save_data = {"player_stats": player, "npc_stats": npcs, "time_stats": time, "current_scene_id": scene_id}
    try:
        with open(SAVE_FILE, 'w', encoding='utf-8') as f: json.dump(save_data, f, ensure_ascii=False, indent=4)
    except Exception: pass
def load_game():
    if not os.path.exists(SAVE_FILE): return None, None, None, None
    try:
        with open(SAVE_FILE, 'r', encoding='utf-8') as f: save_data = json.load(f)
        return save_data["player_stats"], save_data["npc_stats"], save_data["time_stats"], save_data["current_scene_id"]
    except Exception: return None, None, None, None

# --- éŠæˆ²è³‡æ–™ ---
player_stats = {"wealth": 2500, "intelligence": 5, "appearance": 5, "height": 165, "inventory": [], "stamina": 100, "max_stamina": 100, "flags": []}
GIRL_PROFILES = [
    {"key": "volleyball_girl", "name": "é¹½ç›¤çŽ‰", "gender": "å¥³", "affection_key": "volleyball_girl_affection", "description": "å–œæ­¡æ‰“æŽ’çƒçš„æ´»æ½‘å¥³å­©ï¼Œèˆ‡ä½ åŒç³»ä¸åŒç­ï¼ŒåƒåŠ ç³»æŽ’çš„è©±æžä¸å¥½æœƒèªè­˜åˆ°å¥¹ã€‚", "hobbies": "æ‰“æŽ’çƒ", "focus": "èº«é«˜ã€æ™ºæ…§", "location": "æŽ’çƒå ´ã€ç³»æŽ’ã€æ ¡åœ’å„è™•"},
    {"key": "top_student_girl", "name": "èˆžæ¢“çª", "gender": "å¥³", "affection_key": "top_student_girl_affection", "description": "å®‰éœã€å–œæ­¡è®€æ›¸å’Œå½ˆé‹¼ç´çš„å­¸éœ¸ï¼Œèˆ‡ä½ åŒç³»ä¸åŒç­ï¼ŒåƒåŠ é‹¼ç´ç¤¾æˆ–å¸¸åŽ»åœ–æ›¸é¤¨æžä¸å¥½èªè­˜ä»–ã€‚", "hobbies": "è®€æ›¸ã€å½ˆé‹¼ç´", "focus": "æ™ºæ…§ã€è²¡å¯Œ", "location": "åœ–æ›¸é¤¨ã€é‹¼ç´ç¤¾ã€æ ¡åœ’å„è™•"},
    {"key": "childhood_friend", "name": "éœ²æ¯”", "gender": "å¥³", "affection_key": "childhood_friend_affection", "description": "å¾žå°ä¸€èµ·é•·å¤§çš„æœ‹å‹ï¼Œå–œæ­¡æ‰“é›»å‹•å’Œå‡ºåŽ»çŽ©ï¼Œèˆ‡ä½ é’æ¢…ç«¹é¦¬ä½†å¾ˆä¹…æ²’æœ‰è¯ç¹«ï¼Œä¸Šå¤§å­¸æ‰ç™¼ç¾ç«Ÿç„¶èˆ‡ä½ åŒç­åŒå­¸ã€‚", "hobbies": "æ‰“é›»å‹•ã€å‡ºåŽ»çŽ©", "focus": "èº«é«˜ã€é¡å€¼", "location": "èª²å ‚ä¸Šã€æ ¡åœ’å„è™•"},
    {"key": "part_time_girl", "name": "Selina", "gender": "å¥³", "affection_key": "part_time_girl_affection", "description": "åœ¨å’–å•¡å»³æ‰“å·¥ï¼Œå–œæ­¡ç”œé»žçš„å¯æ„›å¥³å­©ï¼Œå°±è®€å•†è¨­ç³»ï¼Œå¦‚æžœéŒ¢å¤ªå°‘åŽ»æ‰“å·¥çš„è©±æžä¸å¥½æœƒèªè­˜ä»–ã€‚", "hobbies": "ç”œé»ž", "focus": "è²¡å¯Œã€é¡å€¼", "location": "å’–å•¡å»³ã€æ ¡åœ’å„è™•"},
    {"key": "boy", "name": "æž—æ™¨ç¿”", "gender": "ç”·", "affection_key": "boy_affection", "description": "å–œå¥½æ‰“ç±ƒçƒå’Œå¥èº«ï¼Œæœ‰åƒåŠ ç³»ç±ƒï¼Œèˆ‡ä½ åœ¨é–‹å­¸é€±æˆç‚ºæœ‹å‹ï¼Œæ™‚å¸¸ä¸€èµ·è¡Œå‹•", "hobbies": "æ‰“ç±ƒçƒã€å¥èº«", "focus": "ç„¡","location": "ç±ƒçƒå ´ã€æ ¡åœ’å„è™•"},
]

npc_stats = {
    "volleyball_girl": {"affection": 30, "trust": 0},
    "top_student_girl": {"affection": 30, "trust": 0},
    "childhood_friend": {"affection": 40, "jealousy": 0}, # é’æ¢…ç«¹é¦¬çš„åˆå§‹å¥½æ„Ÿåº¦ç‚º20
    "part_time_girl": {"affection": 30, "trust": 0},
    "boy": {"affection": 50, "trust": 0},
}
# --- æ–°çš„æ™‚é–“çµæ§‹ ---
DAYS_OF_WEEK = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”"]
time_stats = {"week": 1, "day_of_week_index": 0, "period_index": 0} # week, day_index, period_index
scheduled_events = {
    "W1_D0": "w1_d0_event", # é€±ä¸€
    "W1_D2": "w1_d1_event", # é€±ä¸‰
    "W1_D4": "w1_d2_event", # é€±äº”
    "W2_D0": "w2_d0_event", # ç¬¬äºŒé€±é€±ä¸€
    "W2_D2": "w2_d1_router",# ç¬¬äºŒé€±é€±ä¸‰
    "W3_D0": "w3_d0_router",# ç¬¬ä¸‰é€±é€±ä¸€
    "W3_D2": "w3_d1_router",# ç¬¬ä¸‰é€±é€±ä¸‰
    "W3_D4": "w3_d2_event", # ç¬¬ä¸‰é€±é€±äº”
    "W4_D0": "w4_d0_event", # ç¬¬å››é€±é€±ä¸€
    "W4_D2": "w4_d1_event", # ç¬¬å››é€±é€±ä¸‰
    "W4_D4": "w4_d2_router",# ç¬¬å››é€±é€±äº”
    "W5_D0": "w5_d0_event", # ç¬¬äº”é€±é€±ä¸€
    "W5_D2": "w5_d1_router",# ç¬¬äº”é€±é€±ä¸‰
    "W5_D4": "w5_d2_event", # ç¬¬äº”é€±é€±äº”
    "W6_D0": "w6_midterm_exam" # ç¬¬å…­é€±é€±ä¸€
}

story = {
    # è«‹åœ¨é€™è£¡è²¼ä¸Šä½ ä¿®æ”¹å¾Œçš„åŠ‡æƒ…
    # é€™æ˜¯éŠæˆ²é–‹å§‹çš„é€²å…¥é»ž
    "game_intro": {
        "text": "ä½ æ˜¯ä¸€åä¸­åŽŸå¤§å­¸é›»æ©Ÿç³»å¤§ä¸€æ–°ç”Ÿï¼Œè«‹é–‹å§‹ä½ çš„é–‹å±€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w1_d0_event"}],
        "no_time_cost": True
    },

    # --- ç¬¬ä¸€é€±åŠ‡æƒ… ---
    "w1_d0_event": {
        "text": "å°ä¸Šæ ¡é•·é‚„åœ¨è‡´è©žï¼Œä½ è¦ºå¾—æœ‰é»žæ‚¶ã€‚é€™æ™‚æ—é‚Šä¸€å€‹è†šè‰²é»é»‘ã€çœ‹èµ·ä¾†å‰›é‹å‹•å®Œçš„ç”·ç”Ÿæ¹ŠéŽä¾†ã€‚\né˜¿ç¿”ï¼šã€Œå˜¿ï¼å“¥å€‘ï¼Œä½ ä¹Ÿæ˜¯ç”²ç­çš„å—Žï¼Ÿæˆ‘æ˜¯æž—æ™¨ç¿”ã€‚å‰›æ‰åœ¨å¤–é¢çœ‹åˆ°é›»æ©Ÿç³»çš„ç³»ç‰Œï¼Œæ„Ÿè¦ºé€™å››å¹´æˆ‘å€‘æœƒéŽå¾—å¾ˆç¡¬å•Š...ä½ æœ‰æƒ³å¥½è¦æ€Žéº¼æ··...å–”ä¸ï¼Œæ€Žéº¼éŽé€™å››å¹´äº†å—Žï¼Ÿã€",
        "choices": [
            {"text": "æ‰“ç®—å…ˆèªçœŸè½èª²ï¼Œé›»æ©Ÿç³»è½èªªå¾ˆé‡åŸºç¤Žã€‚", "next_scene": "w1_d0_choice1"},
            {"text": "æƒ³å¤šé‹å‹•æˆ–ä¿é¤Šï¼Œè½èªªé›»æ©Ÿç³»å®…ç”·å¾ˆå¤šï¼Œæˆ‘ä¸æƒ³è®Šé‚£æ¨£ã€‚", "next_scene": "w1_d0_choice2"}
        ],
        "no_time_cost": True
    },
    "w1_d0_choice1": {
        "text": "é˜¿ç¿”ä¸€è‡‰æ•¬ä½©ï¼šã€Œå“‡ï¼Œé€™å°±æ˜¯å‚³èªªä¸­çš„å­¸éœ¸æ½›åŠ›è‚¡å—Žï¼Ÿé‚£ä¹‹å¾Œå¾®ç©åˆ†å¯ä»¥åä½ æ—é‚Šå—Žï¼Ÿã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"intelligence": 0.3}}}],
        "no_time_cost": True
    },
    "w1_d0_choice2": {
        "text": "é˜¿ç¿”å˜¿å˜¿ä¸€ç¬‘ï¼šã€Œæœ‰çœ¼å…‰ï¼æˆ‘ä¹Ÿæ‰“ç®—åŽ»ç³»ç±ƒæŽ’æˆ–å¥èº«æˆ¿ï¼Œåˆ°æ™‚å€™ä¸€èµ·å•Šï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"appearance": 1}}}],
        "no_time_cost": True
    },
    "w1_d1_event": {
        "text": "å»£å ´ä¸Šéƒ½æ˜¯å„ç³»çš„æ–°ç”Ÿï¼Œå¤§å®¶éƒ½åœ¨é ˜å‚³å–®ã€‚ä½ ä¾†åˆ°æ„Ÿèˆˆè¶£çš„æ”¤ä½å‰ï¼š",
        "choices": [
            {"text": "å‰å¾€ã€Œç³»æŽ’çƒã€æ”¤ä½", "next_scene": "w1_d1_volleyball"},
            {"text": "å‰å¾€ã€Œé‹¼ç´ç¤¾ã€æ”¤ä½", "next_scene": "w1_d1_piano"}
        ],
        "no_time_cost": True
    },
    "w1_d1_volleyball": {
        "text": "ä½ å‰›é è¿‘æŽ’çƒç¶²ï¼Œä¸€é¡†çƒæ»¾åˆ°ä½ è…³é‚Šã€‚ä¸€å€‹ç´®è‘—ä¿è½é¦¬å°¾ã€ç©¿è‘—é‹å‹•æœçš„å¥³å­©è·‘éŽä¾†ï¼Œå¥¹èƒ¸å‰æŽ›è‘—æ–°ç”Ÿåç‰Œï¼Œå¯«è‘—ã€Œä¹™ç­ï¼å¦ç›¤çŽ‰ã€ã€‚\nå¦ç›¤çŽ‰ï¼šã€ŒåŒå­¸ï¼é‚£æ˜¯æˆ‘çš„çƒï¼Œå¯ä»¥å¹«æˆ‘æ’¿ä¸€ä¸‹å—Žï¼Ÿè¬å•¦ï¼...æ¬¸ï¼Ÿæˆ‘çœ‹ä½ åç‰Œï¼Œä½ ä¹Ÿæ˜¯é›»æ©Ÿç³»çš„å–”ï¼Ÿæˆ‘æ˜¯ä¹™ç­çš„ç›¤çŽ‰ã€‚æˆ‘å€‘ç­é‚£ç¾¤ç”·ç”Ÿéƒ½ç¸®åœ¨å®¿èˆæ‰“é›»å‹•ï¼Œä½ è¦ä¸è¦ä¹¾è„†ä¾†è·Ÿæˆ‘å€‘ä¸€èµ·æ‰“çƒï¼Ÿå¤§å®¶éƒ½æ˜¯å‰›é–‹å§‹ç·´ï¼Œå¾ˆæœ‰è¶£å–”ï¼ã€",
        "choices": [
            {"text": "è½èµ·ä¾†ä¸éŒ¯ï¼Œæ±ºå®šåŠ å…¥ç³»æŽ’ï¼", "next_scene": "financial_review", "effects": {"player": {"stamina": -20, "max_stamina": 5}, "add_flags": ["met_volleyball_girl", "joined_volleyball_team"], "npcs": {"volleyball_girl": {"affection": 5}}}},
            {"text": "å†è€ƒæ…®çœ‹çœ‹ã€‚", "next_scene": "financial_review", "effects": {"player": {"stamina": -20}, "add_flags": ["met_volleyball_girl"], "npcs": {"volleyball_girl": {"affection": 5}}}}
        ],
        "no_time_cost": True
    },
    "w1_d1_piano": {
        "text": "ä½ åœ¨æ”¤ä½æ—çœ‹åˆ°ä¸€å€‹æ­£å°è‘—ç¤¾åœ˜ç°¡ç« ç™¼å‘†çš„å¥³å­©ã€‚å¥¹æ°£è³ªå®‰éœï¼Œåç‰Œä¸Šå¯«è‘—ã€Œä¹™ç­ï¼èˆžæ¢“çªã€ã€‚\nèˆžæ¢“çªï¼šã€Œï¼ˆè½‰é ­çœ‹åˆ°ä½ ï¼Œæ„£äº†ä¸€ä¸‹ï¼‰...ä½ ä¹Ÿæ˜¯æƒ³åŠ å…¥é‹¼ç´ç¤¾çš„æ–°ç”Ÿå—Žï¼Ÿæˆ‘å‰›æ‰å•éŽï¼Œä»–å€‘èªªç´æˆ¿é€™é€±é‚„æ²’é–‹æ”¾çµ¦å¤§ä¸€é ç´„...æˆ‘æœ‰åœ¨åœ–æ›¸é¤¨çœ‹åˆ°å¹¾æœ¬é›»æ©Ÿç³»çš„åƒè€ƒæ›¸ï¼Œæ­£æ‰“ç®—éŽåŽ»çœ‹ã€‚ä½ è¦åŽ»ç¤¾åœ˜ï¼Œé‚„æ˜¯åŽ»åœ–æ›¸é¤¨ï¼Ÿã€",
        "choices": [
            {"text": "æ±ºå®šåŠ å…¥é‹¼ç´ç¤¾ã€‚", "next_scene": "financial_review", "effects": {"player": {"intelligence": 0.3}, "add_flags": ["met_top_student_girl", "joined_piano_club"], "npcs": {"top_student_girl": {"affection": 5}}}},
            {"text": "é‚„æ˜¯å…ˆå°ˆå¿ƒåœ¨èª²æ¥­ä¸Šå¥½äº†ã€‚", "next_scene": "financial_review", "effects": {"player": {"intelligence": 0.3}, "add_flags": ["met_top_student_girl"], "npcs": {"top_student_girl": {"affection": 5}}}}
        ],
        "no_time_cost": True
    },
    "financial_review": {
        "text": "ç¤¾åœ˜çš„äº‹æƒ…æ±ºå®šå¾—å·®ä¸å¤šäº†ï¼ŒæŽ¥ä¸‹ä¾†è©²è¦åŠƒä¸€ä¸‹æœªä¾†å¹¾é€±çš„é–‹éŠ·äº†ã€‚ä½ æ‰“é–‹è‡ªå·±çš„è¨˜å¸³æœ¬ï¼Œå›žé¡§ä¸Šé€±çš„èŠ±è²»å¾Œï¼Œå¿ƒæƒ³â€¦",
        "choices": [
            {"text": "ä¸€å€‹ç¦®æ‹œçš„é›¶ç”¨é‡‘å¥½åƒæœ‰é»žä¸å¤ ç”¨......", "next_scene": "financial_choice_poor"},
            {"text": "å‰›å¥½è¶³å¤ ï¼ŒåŸºæœ¬é–‹éŠ·æ²’æœ‰å•é¡Œã€‚", "next_scene": "financial_choice_ok"},
            {"text": "è¶…ç´šå……è¶³ï¼é‚„èƒ½å­˜ä¸‹ä¸€äº›å‘¢ã€‚", "next_scene": "daily_router"}
        ],
        "no_time_cost": True
    },
    "financial_choice_poor": {
        "text": "ä½ çœ‹è‘—ç©ºç©ºå¦‚ä¹Ÿçš„éŒ¢åŒ…ï¼Œæ±ºå®šåŽ»å’–å•¡å»³æ‰“å·¥ï¼Œç‚ºè‡ªå·±å¢žåŠ é»žæ”¶å…¥ã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"add_flags": ["will_work_part_time"]}}],
        "no_time_cost": True
    },
    "financial_choice_ok": {
        "text": "é›–ç„¶é–‹éŠ·å‰›å¥½ï¼Œä½†ä½ çœ‹è‘—å•†åº—è£¡æœ€æ–°æ¬¾çš„éŠæˆ²æ©Ÿï¼Œå¿ƒæƒ³...",
        "choices": [
            {"text": "æ‰“å·¥å­˜éŒ¢è²·è‡ªå·±æƒ³è¦çš„æ±è¥¿ã€‚", "next_scene": "financial_choice_ok_yes"},
            {"text": "æ„Ÿè¦ºå¥½éº»ç…©ï¼Œå…ˆä¸è¦å¥½äº†ã€‚", "next_scene": "daily_router"}
        ],
        "no_time_cost": True
    },
    "financial_choice_ok_yes": {
        "text": "ä½ æ±ºå®šé–‹å§‹æ‰“å·¥ï¼Œç‚ºè‡ªå·±çš„å¤¢æƒ³åŸºé‡‘åŠªåŠ›ã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "coffee_shop_router", "effects": {"add_flags": ["will_work_part_time"]}}],
        "no_time_cost": True
    },
    "w1_d2_event": {
        "text": "å ´æ™¯ï¼š é›»æ©Ÿé€šè¨Šå¤§æ¨“ 1 æ¨“æ•™å®¤ã€‚ä½ å‰›æ‰¾å¥½ä½ç½®åä¸‹ï¼Œä¸€å€‹ç†Ÿæ‚‰çš„èº«å½±å¤§æ–å¤§æ“ºåœ°èµ°é€²æ•™å®¤ï¼Œåœåœ¨ä½ çš„èª²æ¡Œæ—ï¼Œæ‰‹è£¡é‚„æ‹¿è‘—ä¸€ç½èƒ½é‡é£²æ–™ã€‚\néœ²æ¯”ï¼šã€Œæ¬¸...é€™ä¸æ˜¯ä½ å—Žï¼Ÿæˆ‘å°±è¦ºå¾—åå­—å¾ˆçœ¼ç†Ÿï¼Œæ²’æƒ³åˆ°ä½ ç«Ÿç„¶è·Ÿæˆ‘åŒç³»åŒç­ï¼ä½ æ˜¯åƒäº†ä»€éº¼é•·å¤§çš„ï¼Ÿæ€Žéº¼è·Ÿå°æ™‚å€™æ„Ÿè¦ºä¸å¤ªä¸€æ¨£äº†ï¼Ÿã€",
        "choices": [
            {"text": "éœ²æ¯”ï¼Ÿå¦³æ€Žéº¼ä¹Ÿä¾†è®€é›»æ©Ÿï¼Ÿå¦³ä¸æ˜¯æœ€è¨ŽåŽ­æ•¸å­¸å—Žï¼Ÿ", "next_scene": "w1_d2_choice1"},
            {"text": "ï¼ˆå†·éœæ‡‰å°ï¼‰å¥½ä¹…ä¸è¦‹ï¼Œå¦³å€’æ˜¯ä¸€é»žéƒ½æ²’è®Šï¼Œé‚„æ˜¯å¾ˆæ„›çŽ©ã€‚", "next_scene": "w1_d2_choice2"}
        ]
    },
    "w1_d2_choice1": {
        "text": "éœ²æ¯”ï¼šã€Œå–‚ï¼åˆ¥æé»‘æ­·å²å•¦ï¼æˆ‘æ˜¯ç‚ºäº†èƒ½è¨­è¨ˆå‡ºæ›´å¥½çŽ©çš„éŠæˆ²æ‰ä¾†çš„ã€‚ä»¥å¾Œå¯¦é©—èª²...ä½ æ‡‚çš„ï¼Œè¦ç½©æˆ‘å–”ï¼ã€",
        "choices": [{"text": "å¥½å•¦å¥½å•¦çŸ¥é“äº†!", "next_scene": "daily_router", "effects": {"npcs": {"childhood_friend": {"affection": 5}}}}]
    },
    "w1_d2_choice2": {
        "text": "éœ²æ¯”ï¼šã€Œå“¼ï¼Œé€™å«ä¿æœ‰ç«¥å¿ƒï¼å°äº†ï¼Œæˆ‘æœ€è¿‘ç™¼ç¾ä¸€å®¶ä¸éŒ¯çš„é›»çŽ©åº—åœ¨é™„è¿‘ï¼Œæ”¹å¤©ä¸€èµ·åŽ»å•Šï¼Ÿã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"appearance": 1}, "npcs": {"childhood_friend": {"affection": 0}}}}]
    },

    # --- ç¬¬äºŒé€±åŠ‡æƒ… ---
    "w2_d0_event": {
        "text": "ã€ç‰©ç†å¯¦é©—èª²çš„éœ‡æ’¼æ•™è‚²ã€‘\nå ´æ™¯ï¼šåŸºç¤Žç§‘å­¸é¤¨å¯¦é©—å®¤ã€‚ä½ æ­£å°è‘—ä¸€å°ç¤ºæ³¢å™¨ç™¼å‘†ï¼Œèž¢å¹•ä¸Šçš„æ³¢å½¢äº‚è·³ï¼Œä½ çš„å¯¦é©—è¨˜éŒ„æœ¬é‚„æ˜¯ä¸€ç‰‡ç©ºç™½ã€‚\né˜¿ç¿”ï¼šã€Œå…„å¼Ÿï¼Œé€™æ©Ÿå™¨æ˜¯ä¸æ˜¯å£žäº†å•Šï¼Ÿæˆ‘æ€Žéº¼èª¿éƒ½èª¿ä¸å‡ºæ­£å¼¦æ³¢...æ¬¸ï¼Œé‚£é‚Šé‚£å€‹æ˜¯éœ²æ¯”å§ï¼Ÿå¥¹å¥½åƒå·²ç¶“å¿«å¯«å®Œäº†ï¼Œæˆ‘å€‘è¦ä¸è¦åŽ»ã€Žåƒè€ƒã€ä¸€ä¸‹ï¼Ÿã€",
        "choices": [
            {"text": "å …æŒè‡ªå·±ç ”ç©¶ï¼Œä¸¦èªçœŸå¯«å ±å‘Š", "next_scene": "w2_d0_choice1"},
            {"text": "åŽ»æ‰¾éœ²æ¯”æ±‚æ•‘", "next_scene": "w2_d0_choice2"}
        ],
        "no_time_cost": True
    },
    "w2_d0_choice1": {
        "text": "ä½ åŸ‹é ­è‹¦å¹¹å…©å°æ™‚ã€‚é˜¿ç¿”ï¼šã€Œä½©æœä½©æœï¼Œæˆ‘å…ˆåŽ»ä¾¿åˆ©å•†åº—è²·é£²æ–™äº†ã€‚ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"intelligence": 0.3, "stamina": -10}}}],
        "no_time_cost": True
    },
    "w2_d0_choice2": {
        "text": "éœ²æ¯”ï¼šã€Œï¼ˆå¾—æ„åœ°æ’¥é ­é«®ï¼‰æ±‚æˆ‘å•Šï¼å¥½å•¦ï¼Œçœ‹åœ¨æˆ‘å€‘èªè­˜é€™éº¼ä¹…çš„ä»½ä¸Šï¼Œé€™çµ„æ•¸æ“šå€Ÿä½ ï¼Œä½†ä¸‹æ¬¡ä½ è¦è«‹æˆ‘å–é£²æ–™ï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"intelligence": 0.1}, "npcs": {"childhood_friend": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w2_d1_router": {
        "type": "router",
        "routes": [
            {"scene": "w2_d1_interview_event", "conditions": {"player_flags": ["will_work_part_time"]}},
            {"scene": "w2_d1_customer_event", "conditions": {}}
        ]
    },
    "w2_d1_interview_event": {
        "text": "ã€æœ¨åŒ å’–å•¡çš„æ‰“å·¥é¢è©¦ã€‘\nå ´æ™¯ï¼šå¯¦è¸è·¯ä¸Šçš„ä¸€å®¶è³ªæ„Ÿå’–å•¡å»³ã€‚ä½ èµ°é€²åº—è£¡æ‡‰å¾µå·¥è®€ç”Ÿï¼Œåº—é•·å«å¦ä¸€ä½å‰›ä¾†ä¸ä¹…çš„æ–°äººå¸¶ä½ ã€‚\nSelinaï¼šã€Œï¼ˆç©¿è‘—åœè£™ï¼Œæ‰‹è£¡æ‹¿è‘—æ‰˜ç›¤è·‘éŽä¾†ï¼‰å—¨ï¼ä½ æ˜¯ä¾†é¢è©¦çš„å—Žï¼Ÿæˆ‘æ˜¯å•†è¨­ç³»çš„ Selinaï¼Œä¹Ÿæ˜¯é€™é€±å‰›é–‹å§‹æ‰“å·¥çš„å¤§ä¸€æ–°ç”Ÿã€‚åº—é•·åœ¨å¾Œé¢å¿™ï¼Œæˆ‘å…ˆå¸¶ä½ èªè­˜ç’°å¢ƒã€‚å°äº†...ä½ æ˜¯é›»æ©Ÿç³»çš„å–”ï¼Ÿè½èªªä½ å€‘ç³»çš„äººéƒ½å¾ˆè°æ˜Žï¼Œé‚£é€™å°è¶…è¤‡é›œçš„ç¾©å¼å’–å•¡æ©Ÿï¼Œä½ æ‡‰è©²ä¸€ä¸‹å°±æœƒä¿®äº†å§ï¼Ÿã€",
        "choices": [
            {"text": "å±•ç¾è‡ªä¿¡ï¼Œé †ä¾¿èª‡çŽåº—è£¡è£æ½¢", "next_scene": "w2_d1_interview_choice1"},
            {"text": "èª å¯¦è¡¨ç¤ºè‡ªå·±åªæœƒè®€æ›¸ï¼Œæ©Ÿå™¨é‚„å¾—å­¸", "next_scene": "w2_d1_interview_choice2"}
        ],
        "no_time_cost": True
    },
    "w2_d1_interview_choice1": {
        "text": "Selinaï¼šã€Œï¼ˆçœ¼ç›ä¸€äº®ï¼‰å–”ï¼Ÿä½ å¾ˆæœ‰çœ¼å…‰å˜›ï¼é€™ç‰†ä¸Šçš„æŽ›ç•«æ˜¯æˆ‘å€‘ç³»å­¸å§Šè¨­è¨ˆçš„å–”ã€‚çœ‹ä¾†æˆ‘å€‘æœƒåˆä½œå¾—å¾ˆæ„‰å¿«ï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"wealth": 500}, "add_flags": ["met_selina"], "npcs": {"part_time_girl": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w2_d1_interview_choice2": {
        "text": "Selinaï¼šã€Œå“ˆå“ˆï¼Œä¹Ÿæ˜¯å•¦ã€‚åˆ¥ç·Šå¼µï¼Œæˆ‘ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡ç”¨ï¼Œé‚£æˆ‘å€‘ä¸€èµ·ç ”ç©¶æ€Žéº¼å¼„å‡ºå®Œç¾Žçš„æ‹‰èŠ±å§ï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"wealth": 500, "intelligence": 0.3}, "npcs": {"part_time_girl": {"affection": 5}}, "add_flags": ["met_selina"]}}],
        "no_time_cost": True
    },
    "w2_d1_customer_event": {
        "text": "ã€æœ¨åŒ å’–å•¡çš„åˆå¾Œæ™‚å…‰ã€‘\nå ´æ™¯ï¼šä½ æ‹¿è‘—é›¶ç”¨é‡‘ä¾†åˆ°å¯¦è¸è·¯çš„æœ¨åŒ å’–å•¡ã€‚åº—å…§å¾ˆå®‰éœï¼Œåªæœ‰å¹¾ä½å­¸ç”Ÿåœ¨è®€æ›¸ã€‚\nSelinaï¼šã€Œï¼ˆæ‹¿è‘—èœå–®èµ°éŽä¾†ï¼‰æ­¡è¿Žå…‰è‡¨ï¼æˆ‘æ˜¯ä»Šå¤©çš„å€¼ç­ç”Ÿ Selinaã€‚å˜¿...ä½ æ˜¯é›»æ©Ÿç³»çš„å§ï¼Ÿæˆ‘çœ‹ä½ æ‹¿è‘—é‚£æœ¬è¶…åŽšåŽŸæ–‡é ç¿’æ›¸ã€‚æ—¢ç„¶æ˜¯åŒå­¸ï¼Œæˆ‘å¹«ä½ æŽ¨è–¦ï¼Œä»Šå¤©è¦ä¸è¦è©¦è©¦çœ‹æˆ‘å€‘æœ€æ–°å‡ºçš„è‰èŽ“åƒå±¤ï¼Ÿé€™å¯æ˜¯æˆ‘æœ€å–œæ­¡çš„å–”ï¼ã€",
        "choices": [
            {"text": "é»žä¸€ä»½æ˜‚è²´çš„ç”œé»žå¥—é¤ (è²¡å¯Œ-200)", "next_scene": "w2_d1_customer_choice1"},
            {"text": "åªé»žä¸€æ¯é»‘å’–å•¡ä¸¦é–‹å§‹è®€æ›¸", "next_scene": "w2_d1_customer_choice2"}
        ],
        "no_time_cost": True
    },
    "w2_d1_customer_choice1": {
        "text": "Selina çœ¼ç›ä¸€äº®ï¼šã€Œå–”ï¼æœ‰å“å‘³ï¼é‚£é€™ä»½è›‹ç³•æˆ‘å¹«ä½ ç•«å€‹å¯æ„›çš„åœ–æ¡ˆã€‚æ…¢æ…¢äº«å—å–”ï¼Œé›»æ©Ÿç³»å¸¥å“¥ã€‚ã€",
        "effects": {"player": {"wealth": -200, "appearance": 1}, "npcs": {"part_time_girl": {"affection": 5}}, "add_flags": ["met_selina"]},
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router"}],
        "no_time_cost": True
    },
    "w2_d1_customer_choice2": {
        "text": "Selina åäº†å€‹èˆŒé ­ï¼šã€Œæžœç„¶é›»æ©Ÿç³»çš„äººéƒ½å¾ˆåš´è‚…ã€‚é‚£æˆ‘ä¸åµä½ äº†ï¼Œéœ€è¦åŠ æ°´å†å«æˆ‘ã€‚ã€",
        "effects": {"player": {"intelligence": 1}, "add_flags": ["met_selina"]},
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router"}],
        "no_time_cost": True
    },

    # --- ç¬¬ä¸‰é€±åŠ‡æƒ… ---
    "w3_d0_router": {
        "type": "router",
        "routes": [
            {"scene": "w3_d0_pass", "conditions": {"min_stats": {"intelligence": 6.5}}},
            {"scene": "w3_d0_fail", "conditions": {}}
        ]
    },
    "w3_d0_pass": {
        "text": "ã€é€±ä¸€ï¼šæ™®ç‰©å¯¦é©—å ±å‘Šç™¼é‚„ â€” å¹¾å®¶æ­¡æ¨‚å¹¾å®¶æ„ã€‘\nåŸºç¤Žç§‘å­¸é¤¨çš„èµ°å»Šï¼ŒåŠ©æ•™æŠŠæ”¹å¥½çš„æ™®ç‰©å¯¦é©—å ±å‘Šæ”¾åœ¨æ¡Œä¸Šè®“å¤§å®¶é ˜å–ã€‚\né˜¿ç¿”ï¼šã€Œï¼ˆå“€åšŽï¼‰ä¸æ˜¯å§ï¼æˆ‘å¯«å¾—é€™éº¼è¾›è‹¦æ‰æ‹¿ 60 åˆ†ï¼Ÿé‚£åŠ©æ•™èªªæˆ‘çš„èª¤å·®åˆ†æžæ ¹æœ¬æ˜¯åœ¨å¯«å°èªª...å…„å¼Ÿï¼Œä½ å¹¾åˆ†ï¼Ÿã€\nä½ æ‹¿åˆ°äº† 85 åˆ†ã€‚èˆžæ¢“çªå‰›å¥½èµ°éŽï¼Œæ–œçœ¼çœ‹äº†ä¸€ä¸‹ä½ çš„åˆ†æ•¸ï¼šã€Œï¼ˆèªžæ°£å¹³æ·¡ä½†å¸¶é»žèªå¯ï¼‰æ•¸æ“šè™•ç†å¾—ä¸éŒ¯ï¼Œçœ‹ä¾†ä½ æ²’åœ¨èª²å ‚ä¸Šç¡è¦ºã€‚ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"intelligence": 0.3}, "npcs": {"top_student_girl": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w3_d0_fail": {
        "text": "ã€é€±ä¸€ï¼šæ™®ç‰©å¯¦é©—å ±å‘Šç™¼é‚„ â€” å¹¾å®¶æ­¡æ¨‚å¹¾å®¶æ„ã€‘\nåŸºç¤Žç§‘å­¸é¤¨çš„èµ°å»Šï¼ŒåŠ©æ•™æŠŠæ”¹å¥½çš„æ™®ç‰©å¯¦é©—å ±å‘Šæ”¾åœ¨æ¡Œä¸Šè®“å¤§å®¶é ˜å–ã€‚\né˜¿ç¿”ï¼šã€Œï¼ˆå“€åšŽï¼‰ä¸æ˜¯å§ï¼æˆ‘å¯«å¾—é€™éº¼è¾›è‹¦æ‰æ‹¿ 60 åˆ†ï¼Ÿé‚£åŠ©æ•™èªªæˆ‘çš„èª¤å·®åˆ†æžæ ¹æœ¬æ˜¯åœ¨å¯«å°èªª...å…„å¼Ÿï¼Œä½ å¹¾åˆ†ï¼Ÿã€\nä½ åªæ‹¿åˆ°äº† 55 åˆ†ã€‚\néœ²æ¯”è·‘éŽä¾†æ‹æ‹ä½ ï¼šã€Œæ²’é—œä¿‚å•¦ï¼Œæˆ‘ä¹Ÿæ²’åŠæ ¼ï¼Œæˆ‘å€‘çœŸçš„æ˜¯é›»æ©Ÿç³»çš„é›£å…„é›£å¼Ÿã€‚èµ°ï¼åŽ»åƒå¤§é–€å£çš„ç‚¸é›žå®‰æ…°ä¸€ä¸‹ã€‚ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"stamina": 10}, "npcs": {"childhood_friend": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w3_d1_router": {
        "type": "router",
        "routes": [
            {"scene": "w3_d1_work_event", "conditions": {"player_flags": ["will_work_part_time"]}},
            {"scene": "w3_d1_social_router", "conditions": {}}
        ]
    },
    "w3_d1_work_event": {
        "text": "ã€å’–å•¡å»³çš„æ·±å¤œè¶•ç¨¿ã€‘\næœ¨åŒ å’–å•¡å»³ã€‚æ™šä¸Šä¹é»žï¼Œåº—è£¡æ²’ä»€éº¼å®¢äººï¼Œåªæœ‰Selinaè¶´åœ¨æ«ƒæª¯æ—ï¼Œå°è‘—ä¸€å¤§ç–Šåœ–ç¨¿å˜†æ°£ã€‚\nSelinaï¼šã€Œï¼ˆæŠ¬é ­çœ‹åˆ°ä½ ï¼Œçœ¼ç¥žç–²æ†Šï¼‰å•Šï¼Œä½ ä¾†å•¦ã€‚ä¸å¥½æ„æ€ï¼Œæˆ‘ä»Šå¤©å¯èƒ½æ²’ä»€éº¼é«”åŠ›è·Ÿä½ èŠå¤©...æˆ‘å€‘å•†è¨­ç³»çš„å¤§ä¸€è¨­è¨ˆèª²è¦äº¤ä½œæ¥­äº†ï¼Œæˆ‘ç•«äº†åå¹¾å€‹è‰åœ–éƒ½è¢«è€å¸«é€€ä»¶...ä½ å€‘é›»æ©Ÿç³»çš„ä½œæ¥­é›–ç„¶é›£ï¼Œä½†è‡³å°‘æœ‰æ¨™æº–ç­”æ¡ˆï¼Œå°å§ï¼Ÿã€",
        "choices": [
            {"text": "å¹«å¥¹æ”¶æ‹¾æ¡Œå­ï¼Œè®“å¥¹å°ˆå¿ƒç•«ç•«", "next_scene": "w3_d1_work_choice1"},
            {"text": "å±•ç¾é›»æ©Ÿç³»çš„é‚è¼¯ï¼Œå¹«å¥¹åˆ†æžæ§‹åœ–", "next_scene": "w3_d1_work_choice2"}
        ],
        "no_time_cost": True
    },
    "w3_d1_work_choice1": {
        "text": "Selinaï¼šã€Œè¬è¬ä½ ï¼Œä½ äººçœŸå¥½ã€‚ç­‰æˆ‘é€™é€±éŽå®Œï¼Œæˆ‘ä¸€å®šè¦è«‹ä½ åƒæˆ‘å€‘ç³»ä¸Šæœ€æœ‰åçš„æ­å§†è›‹ï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"wealth": 500, "stamina": -10}, "npcs": {"part_time_girl": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w3_d1_work_choice2": {
        "text": "ä½ è©¦åœ–ç”¨é»ƒé‡‘æ¯”ä¾‹è§£é‡‹ã€‚Selina å™—å“§ä¸€ç¬‘ï¼šã€Œé›–ç„¶è½ä¸æ‡‚ä½ åœ¨èªªä»€éº¼ï¼Œä½†æ„Ÿè¦ºå¾ˆæœ‰è¶£ï¼Œè¬è¬ä½ çš„é¼“å‹µå•¦ï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"intelligence": 0.3, "stamina": -20}, "npcs": {"part_time_girl": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w3_d1_social_router": {
        "type": "router",
        "routes": [
            {"scene": "w3_d1_social_volleyball", "conditions": {"player_flags": ["joined_volleyball_team"]}},
            {"scene": "w3_d1_social_piano", "conditions": {"player_flags": ["joined_piano_club"]}},
            {"scene": "w3_d1_social_dorm", "conditions": {}}
        ]
    },
    "w3_d1_social_volleyball": {
        "text": "ã€ç¤¾åœ˜ä¾‹æœƒèˆ‡é¡å¤–çš„ç·´ç¿’ã€‘\nä¸‹åˆæ²’èª²ï¼Œä½ ææ—©ä¾†åˆ°æŽ’çƒå ´ã€‚å¦ç›¤çŽ‰æ­£ä¸€å€‹äººåœ¨ç·´ç¿’å°ç‰†æ“Šçƒã€‚\nå¦ç›¤çŽ‰ï¼šã€Œå˜¿ï¼ä½ ä»Šå¤©ä¸ç”¨æ‰“å·¥å–”ï¼Ÿå¤ªå¥½äº†ï¼Œå¹«æˆ‘é¤µçƒå¥½å—Žï¼Ÿæˆ‘æƒ³ç·´ç¿’æŽ¥ç™¼çƒï¼Œç·´å®Œæˆ‘è«‹ä½ å–é‹å‹•é£²æ–™ï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"stamina": -20, "max_stamina": 5}, "npcs": {"volleyball_girl": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w3_d1_social_piano": {
        "text": "ã€ç¤¾åœ˜ä¾‹æœƒèˆ‡é¡å¤–çš„ç·´ç¿’ã€‘\nä¸‹åˆæ²’èª²ï¼Œç´æˆ¿å‰›å¥½æ²’äººï¼Œä½ åä¸‹ç·´ç¿’ã€‚é€™æ™‚ èˆžæ¢“çª æŽ¨é–€é€²ä¾†ã€‚\nèˆžæ¢“çªï¼šã€Œ...æ²’æƒ³åˆ°é™¤äº†æˆ‘ï¼Œé‚„æœ‰äººæœƒåœ¨é€™å€‹æ™‚é–“éŽä¾†ã€‚ä½ å‰›æ‰å½ˆçš„é‚£æ®µæŒ‡æ³•æœ‰é»žå•é¡Œï¼Œè¦æˆ‘ç¤ºç¯„ä¸€æ¬¡å—Žï¼Ÿã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"intelligence": 0.3}, "npcs": {"top_student_girl": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w3_d1_social_dorm": {
        "text": "ã€ç¤¾åœ˜ä¾‹æœƒèˆ‡é¡å¤–çš„ç·´ç¿’ã€‘\nä¸‹åˆæ²’èª²ï¼Œåœ¨é–€å£é‡åˆ°æº–å‚™å‡ºé–€çš„ éœ²æ¯”ã€‚\néœ²æ¯”ï¼šã€Œæ¬¸ï¼ä½ ä»Šå¤©æ€Žéº¼é€™éº¼é–’ï¼Ÿå‰›å¥½ï¼Œæˆ‘çš„ Switch æ‰‹æŠŠå£žäº†ï¼Œä½ é™ªæˆ‘åŽ»ä¸­åŽŸå•†åœˆä¿®ï¼Œé †ä¾¿å¹«æˆ‘æŒ‘æ–°çš„ä¿è­·æ®¼ï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"appearance": 1}, "npcs": {"childhood_friend": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w3_d2_event": {
        "text": "ã€æ–°ç”Ÿç›ƒé è³½çš„é‚€ç´„ã€‘\nå‚æ™šä¸‹èª²ï¼Œä½ æ­£çŒ¶è±«è¦åŽ»å“ªï¼Œæ‰‹æ©Ÿè·³å‡ºå…©æ¢è¨Šæ¯ã€‚\nè¨Šæ¯ 1 (å¦ç›¤çŽ‰): ã€Œä»Šå¤©æˆ‘å€‘ç­è¦è·Ÿç”²ç­æ‰“å‹èª¼è³½ï¼Œç¼ºå€‹è¨˜éŒ„å“¡ï¼Œé †ä¾¿å¹«æˆ‘åŠ æ²¹ï¼Œæœ‰ç©ºéŽä¾†å—Žï¼Ÿã€\nè¨Šæ¯ 2 (é˜¿ç¿”): ã€Œå…„å¼Ÿï¼æˆ‘å‰›åœ¨å¥èº«æˆ¿é‡åˆ°éœ²æ¯”ï¼Œå¥¹èªªæƒ³åŽ»è²·ä¿é¤Šå“é †ä¾¿é€›ä¸­åŽŸå¤œå¸‚ï¼Œå«æˆ‘å•ä½ è¦ä¸è¦ä¸€èµ·ï¼Ÿã€",
        "choices": [
            {"text": "å‰å¾€æŽ’çƒå ´ï¼ˆæ”¯æŒå¦ç›¤çŽ‰ï¼‰", "next_scene": "w3_d2_choice1"},
            {"text": "å‰å¾€å¤œå¸‚ï¼ˆé™ªéœ²æ¯”èˆ‡é˜¿ç¿”ï¼‰", "next_scene": "w3_d2_choice2"}
        ]
    },
    "w3_d2_choice1": {
        "text": "æ¯”è³½çµæŸå¾Œï¼Œç›¤çŽ‰æ»¿é ­å¤§æ±—åœ°è·‘å‘ä½ ã€‚ã€Œè¬å•¦ï¼å‰›æ‰é‚£çƒæ‰£æ®ºå¸¥å§ï¼Ÿé›–ç„¶æˆ‘åªæ˜¯å¤§ä¸€æ–°ç”Ÿï¼Œä½†æˆ‘ä¸€å®šæœƒè®Šå¼·çš„ï¼ä½ è¦ä¸è¦ä¹Ÿä¾†è©¦è©¦çœ‹æŽ¥é€™çƒï¼Ÿã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"stamina": -25}, "npcs": {"volleyball_girl": {"affection": 5}}}}]
    },
    "w3_d2_choice2": {
        "text": "éœ²æ¯”åœ¨è—¥å¦åº—æŒ‘é¸é¢è†œã€‚ã€Œæ¬¸ï¼Œä½ è¦ºå¾—é€™å€‹åŒ…è£å¥½çœ‹ï¼Œé‚„æ˜¯é‚£å€‹ï¼Ÿ...ç®—äº†ï¼Œåæ­£ä½ é€™å€‹ç›´ç”·è‚¯å®šä¸æ‡‚ï¼Œé¸ä½ è¦ºå¾—å¸¥çš„é‚£å€‹å¥½äº†ï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"appearance": 1, "stamina": 5}, "npcs": {"childhood_friend": {"affection": 5}}}}]
    },

    # --- ç¬¬å››é€±åŠ‡æƒ… ---
    "w4_d0_event": {
        "text": "ã€é€±ä¸€ï¼šåœ–æ›¸é¤¨çš„ã€Œä½å­çˆ­å¥ªæˆ°ã€ã€‘\næ—©ä¸Šå…«é»žçš„å¼µéœæ„šç´€å¿µåœ–æ›¸é¤¨é–€å£ï¼Œé‚„æ²’é–‹é–€å°±æŽ’æ»¿äº†äººã€‚ä½ é é çœ‹åˆ°èˆžæ¢“çªå·²ç¶“ç«™åœ¨éšŠä¼æœ€å‰é¢ï¼Œä½Žé ­çœ‹è‘—è‹±æ–‡å–®å­—å¡ã€‚\nèˆžæ¢“çªï¼šã€Œï¼ˆçœ‹åˆ°ä½ èµ°è¿‘ï¼Œå¾®å¾®æŠ¬é ­ï¼‰ä½ ä¹Ÿé€™éº¼æ—©ä¾†ï¼Ÿ...é›»æ©Ÿç³»çš„å¾®ç©åˆ†è·Ÿé›»è·¯å­¸å¦‚æžœä¸æå‰å…©é€±æº–å‚™ï¼Œé€šå¸¸æœƒå¯«ä¸å®Œã€‚æˆ‘å¹«æˆ‘æœ‹å‹ä½”äº†ä½å­ï¼Œä½†å¥¹å¥½åƒä¸ä¾†äº†ï¼Œä½ è¦åæˆ‘æ—é‚Šå—Žï¼Ÿä½†...ä¸å‡†ç™¼å‡ºè²éŸ³ã€‚ã€",
        "choices": [
            {"text": "ååœ¨å¥¹æ—é‚ŠèªçœŸè®€æ›¸ï¼ˆä¸é€²é£Ÿæ¨¡å¼ï¼‰", "next_scene": "w4_d0_choice1"},
            {"text": "ç®—äº†ï¼ŒåŽ»åœ°ä¸‹å®¤è·Ÿé˜¿ç¿”é‚ŠèŠå¤©é‚Šè®€", "next_scene": "w4_d0_choice2"}
        ],
        "no_time_cost": True
    },
    "w4_d0_choice1": {
        "text": "å…©äººç›¸å°ç„¡è¨€è®€äº†å››å°æ™‚ã€‚èˆžæ¢“çªèµ·æ­¥é›¢é–‹æ™‚ï¼Œåœ¨ä½ æ¡Œä¸Šè²¼äº†å¼µä¾¿åˆ©è²¼ï¼šã€Žé€™é¡Œé›»è·¯åˆ†æžä½ ç®—éŒ¯äº†ã€‚ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"intelligence": 0.3, "stamina": -30}, "npcs": {"top_student_girl": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w4_d0_choice2": {
        "text": "é˜¿ç¿”ï¼šã€Œå…„å¼Ÿï¼Œå‰›æ‰é‚£é‚Šé‚£å€‹æ­£å¦¹æ˜¯åœ¨ç´„ä½ å—Žï¼Ÿä½ ç«Ÿç„¶æ‹’çµ•ï¼Ÿä½©æœä½©æœï¼Œä¾†ï¼Œæˆ‘å€‘ä¾†è¨Žè«–å¾…æœƒåˆé¤åƒå“ªå®¶å¾¡é£¯ç³°ã€‚ã€",
        "effects": {"player": {"intelligence": 0.1, "stamina": 5}, "npcs": {"top_student_girl": {"affection": 5}}},
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router"}],
        "no_time_cost": True
    },
    "w4_d1_event": {
        "text": "ã€é€±ä¸‰ï¼šè€ƒå¤é¡Œçš„èª˜æƒ‘ â€” æ•™å®¤è£¡çš„é¨·å‹•ã€‘\né›»è·¯å­¸èª²é–“ä¼‘æ¯ï¼Œå¤§å®¶éƒ½åœ¨å‚³é–±å­¸é•·å§ç•™ä¸‹ä¾†çš„ã€Œè€ƒå¤é¡Œã€ã€‚éœ²æ¯”æ‹¿è‘—æ‰‹æ©Ÿï¼Œä¸€è‡‰ç³¾çµåœ°çœ‹è‘—ä½ ã€‚\néœ²æ¯”ï¼šã€Œæ¬¸...[ä¸»è§’å]ï¼Œæ€Žéº¼è¾¦å•¦ï¼é€™ä»½è€ƒå¤é¡Œæˆ‘é€£é¡Œç›®éƒ½çœ‹ä¸æ‡‚ï¼Œé€™å­¸æœŸæ˜¯ä¸æ˜¯è¦æ¶¼äº†ï¼Ÿä½ æœ‰æ²’æœ‰èªè­˜ä»€éº¼åŽ²å®³çš„äººå¯ä»¥æ•™æˆ‘ï¼Ÿ...é‚„æ˜¯ï¼Œä½ é€™é€±æœ«å¯ä»¥ä¾†æˆ‘å®¶ï¼Œæˆ‘å€‘ä¸€èµ·ç ”ç©¶ï¼Ÿæˆ‘æœ‰è²·æ–°çš„æç¥žé£²æ–™å–”ï¼ã€",
        "choices": [
            {"text": "ç­”æ‡‰éœ²æ¯”ï¼Œé€±æœ«ä¸€èµ·è®€æ›¸ï¼ˆé’æ¢…ç«¹é¦¬è·¯ç·šï¼‰", "next_scene": "w4_d1_choice1"},
            {"text": "æ‹’çµ•ï¼Œè¡¨ç¤ºè‡ªå·±ä¹Ÿé‚„æ²’è®€å®Œï¼ˆå°ˆæ³¨è‡ªæˆ‘è·¯ç·šï¼‰", "next_scene": "w4_d1_choice2"}
        ],
        "no_time_cost": True
    },
    "w4_d1_choice1": {
        "text": "éœ²æ¯”é–‹å¿ƒåœ°æ‹ä½ æ‰‹ï¼šã€Œå°±ç­‰ä½ é€™å¥è©±ï¼æ”¾å¿ƒï¼Œæˆ‘æœƒæº–å‚™å¥½é›¶é£Ÿçš„ï¼Œé›–ç„¶...å¯èƒ½éƒ½æ˜¯åžƒåœ¾é£Ÿç‰©ã€‚ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"intelligence": 0.3}, "npcs": {"childhood_friend": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w4_d1_choice2": {
        "text": "éœ²æ¯”å™˜å˜´ï¼šã€Œå“¼ï¼Œæžœç„¶ä¸Šäº†å¤§å­¸å°±è®Šå†·æ·¡äº†ã€‚é‚£æˆ‘åŽ»æ‰¾åˆ¥ç­çš„åŒå­¸å•å¥½äº†...ã€",
        "effects": {"player": {"intelligence": 0.3, "stamina": -10}, "npcs": {"childhood_friend": {"affection": 5}}},
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router"}],
        "no_time_cost": True
    },
    "w4_d2_router": {
        "type": "router",
        "routes": [
            {"scene": "w4_d2_work_event", "conditions": {"player_flags": ["will_work_part_time"]}},
            {"scene": "w4_d2_customer_event", "conditions": {}}
        ]
    },
    "w4_d2_work_event": {
        "text": "ã€é€±äº”ï¼šå’–å•¡å»³çš„è€ƒå‰Kæ›¸æ½®ã€‘\næ™šä¸Šä½ åœ¨æœ¨åŒ å’–å•¡æ‰“å·¥ï¼Œåº—è£¡åæ»¿äº†å¸¶è‘—ç­†é›»å’ŒåŽŸæ–‡æ›¸çš„å­¸ç”Ÿã€‚Selina å¿™è‘—é€é¤ï¼Œçœ‹åˆ°ä½ æ­£è¶ç©ºæª”ç¿»é–‹èª²æœ¬ã€‚\nSelinaï¼šã€Œï¼ˆéžçµ¦ä½ ä¸€å°å¡Šè›‹ç³•é‚Šè§’æ–™ï¼‰è¾›è‹¦å•¦ï¼Œé›»æ©Ÿç³»çš„é«˜æç”Ÿã€‚æˆ‘çœ‹ä»Šå¤©åº—è£¡ä¸€åŠçš„äººéƒ½åœ¨ç®—ä½ å€‘é‚£ç¨®å¥‡æ€ªçš„æ•¸å­¸ç¬¦è™Ÿã€‚å°äº†ï¼Œé€™å¡Šæ˜¯å‰›æ‰åˆ‡å£žçš„å¸ƒæœ—å°¼ï¼Œé€ä½ åƒã€‚çœ‹ä½ é€™å¹¾å¤©é»‘çœ¼åœˆé€™éº¼é‡ï¼Œè¦æ³¨æ„é¡å€¼å•Šï¼Œä¸ç„¶å®¢äººæœƒè¢«ä½ åš‡è·‘å–”ï½žã€",
        "choices": [
            {"text": "è¬è¬å¥¹çš„ç”œé»žä¸¦ç¨å¾®æ•´ç†å„€å®¹ï¼ˆä¿é¤Šï¼‰", "next_scene": "w4_d2_work_choice1"},
            {"text": "å©‰æ‹’ç”œé»žï¼Œå°ˆå¿ƒç ”ç©¶é›»è·¯åœ–ï¼ˆä¸é€²é£Ÿæ¨¡å¼ï¼‰", "next_scene": "w4_d2_work_choice2"}
        ],
        "no_time_cost": True
    },
    "w4_d2_work_choice1": {
        "text": "Selina æ»¿æ„åœ°é»žé ­ï¼šã€Œé€™æ‰å°å˜›ï¼é•·å¾—å¸¥çš„äººå°±ç®—åœ¨ç®—æ•¸å­¸ï¼Œçœ‹èµ·ä¾†ä¹Ÿæ¯”è¼ƒåƒåœ¨æ‹æˆ²ã€‚åŠ æ²¹å•¦ï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"appearance": 0.3, "stamina": 10, "wealth": 500}, "npcs": {"part_time_girl": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w4_d2_work_choice2": {
        "text": "Selina å˜†äº†å£æ°£ï¼šã€ŒçœŸæ˜¯æœ¨é ­...ç®—äº†ï¼Œé‚£é€™å¡Šæˆ‘è‡ªå·±åƒå›‰ã€‚ä½ æ…¢æ…¢é‘½ç ”ä½ çš„ç§‘å­¸å¥§ç§˜å§ã€‚ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"intelligence": 0.3, "stamina": -30, "wealth": 500}, "npcs": {"part_time_girl": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w4_d2_customer_event": {
        "text": "ã€é€±äº”ï¼šå’–å•¡å»³çš„è€ƒå‰Kæ›¸æ½®ã€‘\nåœ–æ›¸é¤¨å·²ç¶“æ“ çˆ†äº†ï¼Œä½ æ‹¿è‘—å……è¶³çš„é›¶ç”¨é‡‘ä¾†åˆ°æœ¨åŒ å’–å•¡é¤¨æ‰¾ä½å­ã€‚åº—å…§äººå±±äººæµ·ï¼ŒSelina æ­£ç©¿æ¢­åœ¨æ¡Œæ¤…é–“å¿™å¾—ä¸å¯é–‹äº¤ã€‚\nSelinaï¼šã€Œï¼ˆçœ‹åˆ°ä½ é€²é–€ï¼Œé©šè¨åœ°æ®æ‰‹ï¼‰å˜¿ï¼æ˜¯ä½ å•Šï¼ä»Šå¤©å…¨æ ¡çš„äººéƒ½è·‘ä¾†æˆ‘å€‘åº—è£¡è®€æ›¸äº†ã€‚çœ‹åœ¨ä½ æ˜¯ã€Žå¸¸å®¢ã€çš„ä»½ä¸Šï¼Œæˆ‘å¹«ä½ ç•™äº†æœ€å¾Œä¸€å€‹é çª—çš„å®‰éœä½å­ï¼Œå¿«éŽä¾†ï¼ã€",
        "choices": [
            {"text": "é»žä¸€ä»½ç²¾ç·»çš„ã€Œè€ƒå‰è¡åˆºå¥—é¤ã€ï¼ˆé‡‘éŒ¢ -250ï¼‰", "next_scene": "w4_d2_customer_choice1"},
            {"text": "åªé»žåŸºæœ¬æ¶ˆè²»ï¼Œè¿…é€Ÿé€²å…¥è®€æ›¸ç‹€æ…‹ï¼ˆæ™ºæ…§è·¯ç·šï¼‰", "next_scene": "w4_d2_customer_choice2"}
        ],
        "no_time_cost": True
    },
    "w4_d2_customer_choice1": {
        "text": "Selina é€é¤æ™‚æ‚„æ‚„åœ¨ä½ çš„æ‹¿éµä¸Šæ‹‰äº†ä¸€å€‹ã€ŒåŠ æ²¹ã€çš„å¿ƒå½¢ã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"wealth": -250, "stamina": 15}, "npcs": {"part_time_girl": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w4_d2_customer_choice2": {
        "text": "é›–ç„¶å’–å•¡å»³æœ‰é»žåµï¼Œä½†ä½ å¼·è¿«è‡ªå·±å°ˆæ³¨åœ¨è¤‡é›œçš„é›»è·¯åœ–ä¸­ã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"intelligence": 0.4, "stamina": -10, "wealth": -120}}}],
        "no_time_cost": True
    },
    # --- ç¬¬äº”é€±åŠ‡æƒ… ---
    "w5_d0_event": {
        "text": "ã€é€±ä¸€ï¼šåœ°ç„å¼çš„ç†¬å¤œé ç¿’ã€‘\nå‡Œæ™¨å…©é»žï¼Œä½ çš„æ¡Œç‡ˆä¾ç„¶äº®è‘—ã€‚çœ¼å‰æ˜¯è¤‡é›œçš„éº¥æ–¯å¨çˆ¾æ–¹ç¨‹å¼ã€‚",
        "choices": [
            {"text": "ä¸é€²é£Ÿï¼Œæ‹¼æ­»è®€æ›¸ï¼ˆæ™ºæ…§æœ€å¤§åŒ–ï¼‰", "next_scene": "w5_d0_result1"},
            {"text": "èªçœŸä¿é¤Šèˆ‡ä¼‘æ¯ï¼Œç¶­æŒé«”åŠ›", "next_scene": "w5_d0_result2"}
        ],
        "no_time_cost": True
    },
    "w5_d0_result1": {
        "text": "ä½ å¿è‘—é£¢é¤“ï¼Œçµ‚æ–¼è§£é–‹äº†åŽ»å¹´çš„è€ƒå¤å¤§é¡Œã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"intelligence": 0.3, "stamina": -30}}}]
    },
    "w5_d0_result2": {
        "text": "ä½ æ±ºå®šå……è¶³ç¡çœ ã€‚é›–ç„¶é€²åº¦æ…¢ä¸€é»žï¼Œä½†ç²¾ç¥žå¾ˆå¥½ã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "daily_router", "effects": {"player": {"appearance": 0.3, "stamina": 10, "intelligence": -0.2}}}]
    },
    "w5_d1_router": {
        "type": "router",
        "routes": [
            {"scene": "w5_d1_selina_event", "conditions": {"player_flags": ["met_selina"]}},
            {"scene": "w5_d1_ruby_event", "conditions": {}}
        ],
        "no_time_cost": True
    },
    "w5_d1_selina_event": {
        "text": "ã€é€±ä¸‰ï¼šç³»é¤¨çš„å’–å•¡è£œçµ¦ã€‘\nä½ å›žå­¸æ ¡æ‹¿ç­†è¨˜ï¼Œé‡åˆ° é˜¿ç¿” æ­£æè‘—å…©è¢‹é£²æ–™ã€‚\né˜¿ç¿”ï¼šã€Œå…„å¼Ÿï¼Œçœ‹ä½ è‡‰è‰²ä¸å¤ªå¥½å–”ã€‚å°äº†ï¼Œå‰›æ‰åœ¨æ ¡é–€å£é‡åˆ° Selinaï¼Œå¥¹å«æˆ‘æŠŠé€™ç“¶æç¥žé£²æ–™çµ¦ä½ ï¼Œèªªé›»æ©Ÿç³»çš„äººåˆ¥åœ¨è€ƒå‰å°±æŽ›æŽ‰äº†ã€‚ã€",
        "choices": [
            {"text": "ç«‹åˆ»å–æŽ‰ä¸¦ç¹¼çºŒè®€æ›¸ï¼ˆæ™ºæ…§è·¯ç·šï¼‰", "effects": {"player": {"intelligence": 0.3, "stamina": 5}, "npcs": {"part_time_girl": {"affection": 5}}}, "next_scene": "daily_router"},
            {"text": "å…ˆå›žå®¿èˆä¿é¤Šï¼Œæ€•è€ƒå®Œè‡‰çˆ›æŽ‰ï¼ˆé¡å€¼è·¯ç·šï¼‰", "effects": {"player": {"appearance": 0.3, "intelligence": -0.2}, "npcs": {"part_time_girl": {"affection": 5}}}, "next_scene": "daily_router"}
        ]
    },
    "w5_d1_ruby_event": {
        "text": "ã€é€±ä¸‰ï¼šç³»é¤¨çš„å’–å•¡è£œçµ¦ã€‘\nä½ å›žå­¸æ ¡æ‹¿ç­†è¨˜ï¼Œé‡åˆ° é˜¿ç¿” æ­£æè‘—å…©è¢‹é£²æ–™ã€‚\né˜¿ç¿”ï¼šã€Œå…„å¼Ÿï¼Œçœ‹ä½ è‡‰è‰²ä¸å¤ªå¥½å–”ã€‚å°äº†ï¼Œå‰›æ‰åœ¨æ ¡é–€å£é‡åˆ° éœ²æ¯”ï¼Œå¥¹å«æˆ‘æŠŠé€™ç“¶æç¥žé£²æ–™çµ¦ä½ ï¼Œèªªé›»æ©Ÿç³»çš„äººåˆ¥åœ¨è€ƒå‰å°±æŽ›æŽ‰äº†ã€‚ã€",
        "choices": [
            {"text": "ç«‹åˆ»å–æŽ‰ä¸¦ç¹¼çºŒè®€æ›¸ï¼ˆæ™ºæ…§è·¯ç·šï¼‰", "effects": {"player": {"intelligence": 0.3, "stamina": 5}, "npcs": {"childhood_friend": {"affection": 5}}}, "next_scene": "daily_router"},
            {"text": "å…ˆå›žå®¿èˆä¿é¤Šï¼Œæ€•è€ƒå®Œè‡‰çˆ›æŽ‰ï¼ˆé¡å€¼è·¯ç·šï¼‰", "effects": {"player": {"appearance": 0.3, "intelligence": -0.2}, "npcs": {"childhood_friend": {"affection": 5}}}, "next_scene": "daily_router"}
        ]
    },
    "w5_d2_event": {
        "text": "ã€é€±äº”ï¼šæœŸä¸­è€ƒå‰çš„å´©æ½°èˆ‡å®‰æ…°ã€‘\nè€ƒå‰æœ€å¾Œä¸€å€‹æ™šä¸Šã€‚ä½ æ„Ÿè¦ºå¤§è…¦å¿«è¦ç‚¸è£‚äº†ã€‚",
        "choices": [
            {"text": "æ‰“é›»è©±çµ¦èˆžæ¢“çªå°ç­”æ¡ˆ", "next_scene": "w5_d2_result1"},
            {"text": "è·Ÿéœ²æ¯”èªžéŸ³é€£ç·šèˆ’å£“", "next_scene": "w5_d2_result2"}
        ],
        "no_time_cost": True
    },
    "w5_d2_result1": {
        "text": "æ¢“çªåœ¨é›»è©±é‚£é ­è²éŸ³å¾®å¼±ï¼šã€Œ...æˆ‘ä¹Ÿå‰›ç®—å®Œç¬¬ä¸‰éã€‚æ—¢ç„¶ä½ ç­”æ¡ˆè·Ÿæˆ‘ä¸€æ¨£ï¼Œæ‡‰è©²æ²’å•é¡Œäº†ã€‚æ˜Žå¤©è¦‹ã€‚ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "week_6_intro", "effects": {"player": {"intelligence": 0.3}, "npcs": {"top_student_girl": {"affection": 5}}}}]
    },
    "w5_d2_result2": {
        "text": "éœ²æ¯”ï¼šã€Œå“Žå‘€åˆ¥è®€äº†å•¦ï¼æˆ‘å€‘ç­é‚£å€‹èª°å·²ç¶“æ±ºå®šæ”¾æ£„å¾®ç©åˆ†äº†ï¼Œä½ æœ‰è®€ä¸€é»žå°±å¾ˆå¼·äº†ã€‚åŠ æ²¹å•¦ï¼Œè€ƒå®Œæˆ‘å¸¶ä½ åŽ»åƒå¤§é¤ï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "week_6_intro", "effects": {"player": {"stamina": 20, "intelligence": -0.2}, "npcs": {"childhood_friend": {"affection": 5}}}}]
    },
    "week_6_intro": {
        "text": "ðŸ æœŸä¸­è€ƒå¤§åˆ¤å®š\nç¾åœ¨ï¼Œè«‹æª¢è¦–ä½ çš„ä¸»è§’å±¬æ€§ã€‚ä½ æº–å‚™å¥½é€²å…¥ ç¬¬å…­é€±ï¼šæœŸä¸­è€ƒç¾å ´ äº†å—Žï¼Ÿ",
        "choices": [{"text": "æº–å‚™å¥½äº†ï¼", "next_scene": "daily_router"}],
        "no_time_cost": True
    },

    # --- ç¬¬å…­é€±åŠ‡æƒ… ---
    "w6_midterm_exam": {
        "text": "ðŸ“ ç¬¬ä¸€éšŽæ®µï¼šå¾®ç©åˆ†èˆ‡é›»è·¯å­¸å·å­\né›»å­¸å¤§æ¨“ 105 æ•™å®¤ã€‚åŠ©æ•™é¢ç„¡è¡¨æƒ…åœ°ç™¼ä¸‹å·å­ï¼Œæ•´é–“æ•™å®¤åªå‰©ä¸‹åŽŸå­ç­†å°–æ‘©æ“¦ç´™å¼µçš„è²éŸ³ã€‚",
        "choices": [
            {"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_intelligence_router"}
        ],
        "no_time_cost": True
    },
    "w6_exam_intelligence_router": {
        "type": "router",
        "routes": [
            {"scene": "w6_exam_pass_high", "conditions": {"min_stats": {"intelligence": 11}}},
            {"scene": "w6_exam_pass_mid", "conditions": {"min_stats": {"intelligence": 7}}},
            {"scene": "w6_exam_fail", "conditions": {}}
        ]
    },
    "w6_exam_pass_high": {
        "text": "ä½ å¯«å¾—éžå¸¸é †æ‰‹ï¼Œé€£æœ€å¾Œä¸€é¡ŒåŠ åˆ†é¡Œéƒ½è¼•é¬†è§£å‡ºã€‚\nææ—©äº¤å·æ™‚ï¼Œååœ¨æ–œå¾Œæ–¹çš„ èˆžæ¢“çª é©šè¨åœ°æŠ¬é ­çœ‹äº†ä½ ä¸€çœ¼ã€‚è€ƒå¾Œå¥¹åœ¨èµ°å»Šæ””ä½ä½ ï¼šã€Œé‚£é¡Œéžç·šæ€§é›»è·¯...ä½ ç®—å‡ºä¾†çš„ç­”æ¡ˆæ˜¯ âˆš2 å—Žï¼Ÿã€å¾—åˆ°è‚¯å®šå›žç­”å¾Œï¼Œå¥¹éœ²å‡ºäº†ç½•è¦‹çš„å¾®ç¬‘ã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_phase2_intro", "effects": {"npcs": {"top_student_girl": {"affection": 5}}, "add_flags": ["passed_midterm"]}}],
        "no_time_cost": True
    },
    "w6_exam_pass_mid": {
        "text": "é›–ç„¶æœ‰äº›é¡Œç›®ä¸å¤ªç¢ºå®šï¼Œä½†é è‘—å‰å¹¾é€±çš„åŠªåŠ›ï¼Œä½ å¯«å®Œäº†å¤§éƒ¨åˆ†ã€‚\nä¸‹èª²å¾Œä½ èˆ‡ é˜¿ç¿” å°ç­”æ¡ˆï¼Œç™¼ç¾éŒ¯äº†ä¸€å…©é¡Œã€‚éœ²æ¯” è·‘éŽä¾†æ‹æ‹ä½ ï¼šã€Œæ²’é—œä¿‚å•¦ï¼æœ‰å¯«å®Œå°±è´éŽä¸€åŠçš„äººäº†ï¼Œæˆ‘å€‘åŽ»è²·æ¯é£²æ–™å£“å£“é©šï¼ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_phase2_intro", "effects": {"npcs": {"childhood_friend": {"affection": 5}}, "add_flags": ["passed_midterm"]}}],
        "no_time_cost": True
    },
    "w6_exam_fail": {
        "text": "è€ƒå·ä¸€åŠä»¥ä¸Šéƒ½æ˜¯ç©ºç™½ï¼Œå¤§è…¦ä¸€ç‰‡æ¼¿ç³Šã€‚\nä½ å¤±é­‚è½é­„åœ°èµ°å‡ºæ•™å®¤ï¼Œèˆžæ¢“çª ç¶“éŽä½ èº«é‚Šæ™‚å˜†äº†å£æ°£ï¼Œæ¬²è¨€åˆæ­¢ã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_phase2_intro", "effects": {"player": {"stamina": -10}, "npcs": {"top_student_girl": {"affection": 5}}}}],
        "no_time_cost": True
    },
    "w6_exam_phase2_intro": {
        "text": "ðŸ”‹ ç¬¬äºŒéšŽæ®µï¼šèº«é«”ç‹€æ³èˆ‡ç²¾ç¥žåŠ›\né€£çºŒä¸‰å¤©çš„è€ƒè©¦çµæŸå¾Œï¼Œä½ ç«™åœ¨æ•™å­¸å¤§æ¨“é–€å£ï¼Œé™½å…‰åˆºçœ¼ã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_stamina_router"}],
        "no_time_cost": True
    },
    "w6_exam_stamina_router": {
        "type": "router",
        "routes": [
            {"scene": "w6_stamina_high", "conditions": {"min_stats": {"stamina": 60}}},
            {"scene": "w6_stamina_low", "conditions": {"max_stats": {"stamina": 20}}},
            {"scene": "w6_stamina_normal", "conditions": {}}
        ]
    },
    "w6_stamina_high": {
        "text": "è€ƒå®Œè©¦ä½ ä¾ç„¶ç²¾ç¥žæŠ–æ“»ï¼Œç”šè‡³æƒ³åŽ»è·‘å€‹å…©åœˆã€‚\nå¦ç›¤çŽ‰ æ¹è‘—çƒè¢‹å‡ºç¾ï¼Œç”¨åŠ›æ‹ä½ çš„èƒŒï¼šã€Œè€ƒå®Œå•¦ï¼çœ‹ä½ é‚„å¾ˆæœ‰ç²¾ç¥žå˜›ï¼Œçƒå ´ç¼ºä¸€å€‹æ””ç¶²çš„ï¼Œèµ°å•¦ï¼ã€",
        "effects": {"npcs": {"volleyball_girl": {"affection": 5}}},
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_phase3_intro"}],
        "no_time_cost": True
    },
    "w6_stamina_low": {
        "text": "ä½ è‡‰è‰²è’¼ç™½ï¼Œå·®é»žåœ¨æ¨“æ¢¯å£çµ†å€’ã€‚\nSelina æ­£å¥½é€å¤–é€ä¾†åˆ°é›»æ©Ÿç³»ï¼Œè¶•ç·Šæ‰¶ä½ä½ ã€‚ã€Œå¤©å•Šï¼ä½ çš„é»‘çœ¼åœˆä¹Ÿå¤ªé‡äº†å§ï¼Ÿé›»æ©Ÿç³»æ˜¯åœ¨è™å¾…å­¸ç”Ÿå—Žï¼Ÿå¿«ï¼Œé€™ç½ç¾æ‰“æžœæ±çµ¦ä½ ï¼Œç®—æˆ‘è«‹å®¢ï¼ã€",
        "effects": {"npcs": {"part_time_girl": {"affection": 5}}},
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_phase3_intro"}],
        "no_time_cost": True
    },
    "w6_stamina_normal": {
        "text": "ä½ æ„Ÿè¦ºæœ‰é»žç´¯ï¼Œä½†é‚„æ’å¾—ä½ã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_phase3_intro"}],
        "no_time_cost": True
    },
    "w6_exam_phase3_intro": {
        "text": "âœ¨ ç¬¬ä¸‰éšŽæ®µï¼šç¤¾äº¤èˆ‡é­…åŠ›å›žé¥‹\nè€ƒå¾Œçš„é€±æœ«ï¼Œæ ¡åœ’æ°›åœæ”¾é¬†äº†ä¸å°‘ã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_appearance_router"}],
        "no_time_cost": True
    },
    "w6_exam_appearance_router": {
        "type": "router",
        "routes": [
            {"scene": "w6_appearance_high", "conditions": {"min_stats": {"appearance": 9}}},
            {"scene": "w6_appearance_low", "conditions": {"max_stats": {"appearance": 6}}},
            {"scene": "w6_appearance_normal", "conditions": {}}
        ]
    },
    "w6_appearance_high": {
        "text": "å³ä½¿ç¶“éŽè€ƒå‰ç†¬å¤œï¼Œä½ çš„çš®è†šä¾ç„¶æ‰“ç†å¾—å¾ˆå¥½ã€‚\nåœ¨æ ¡åœ’æ•£æ­¥æ™‚ï¼Œæœ‰å…¶ä»–ç³»çš„å¥³åŒå­¸ä¸»å‹•æ‰¾ä½ å•è·¯ï¼ˆå…¶å¯¦æ˜¯æƒ³è¦ IGï¼‰ã€‚éœ²æ¯” åœ¨æ—é‚Šçœ‹åˆ°å¾Œé…¸æºœæºœåœ°èªªï¼šã€Œå˜–å˜–ï¼Œé›»æ©Ÿç³»çš„å¸¥å“¥å°±æ˜¯ä¸ä¸€æ¨£ï¼Œè€ƒè©¦éƒ½æ²’æŠŠä½ æ“é†œã€‚ã€",
        "effects": {"npcs": {"childhood_friend": {"affection": 5}}},
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_invitations"}],
        "no_time_cost": True
    },
    "w6_appearance_low": {
        "text": "è€ƒå®Œè©¦å¾Œä½ é¡¯å¾—æœ‰äº›æ‹‰æ¦»ï¼Œé ­é«®äº‚ç³Ÿç³Ÿçš„ã€‚\né˜¿ç¿” èªžé‡å¿ƒé•·åœ°è·Ÿä½ èªªï¼šã€Œå…„å¼Ÿï¼Œé›–ç„¶è€ƒå®Œè©¦äº†ï¼Œä½†ä½ é€™å‰¯æ¨£å­ï¼Œåˆ¥äººçœ‹åˆ°å¯èƒ½æœƒä»¥ç‚ºä½ æ˜¯å“ªä¾†çš„æµæµªæ¼¢å–”...ã€",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_invitations"}],
        "no_time_cost": True
    },
    "w6_appearance_normal": {
        "text": "è€ƒå®Œè©¦ï¼Œä½ çœ‹èµ·ä¾†å’Œå¾€å¸¸ä¸€æ¨£ã€‚",
        "choices": [{"text": "ç¹¼çºŒ...", "next_scene": "w6_exam_invitations"}],
        "no_time_cost": True
    },
    "w6_exam_invitations": {
        "text": "ðŸ† æœŸä¸­è€ƒå¾Œçš„å››å€‹é‚€è«‹ (åˆ†æ­§é»ž)\nè€ƒè©¦çµæŸç•¶æ™šï¼Œä½ çš„æ‰‹æ©Ÿéœ‡å‹•ä¸åœã€‚é€™æ˜¯ä¸€å€‹é‡è¦çš„çŽå‹µäº‹ä»¶ï¼Œä½ åªèƒ½é¸æ“‡ä¸€å€‹åƒåŠ ï¼š",
        "choices": [
            {"text": "èˆžæ¢“çªçš„é‚€è«‹ï¼š ã€Œé€™æ¬¡è€ƒå·æœ‰å¹¾å€‹çˆ­è­°é»žï¼Œæˆ‘æƒ³åŽ»åœ–æ›¸é¤¨æŸ¥è³‡æ–™ï¼Œä½ ...è¦ä¸€èµ·ä¾†å—Žï¼Ÿã€", "next_scene": "ending_ziqi", "requirements": {"min_stats": {"intelligence": 7}, "player_flags": ["chose_library_with_ziqi"]}},
            {"text": "å¦ç›¤çŽ‰çš„é‚€è«‹ï¼š ã€Œæ–°ç”Ÿç›ƒåå–®è¦äº¤äº†ï¼Œé™ªæˆ‘åŽ»é«”è‚²çµ„é€ä»¶ï¼Œé †ä¾¿ä¸€èµ·åƒå€‹å®µå¤œæ…¶ç¥è€ƒå®Œï¼Ÿã€", "next_scene": "ending_panyu", "requirements": {"player_flags": ["joined_volleyball_team"], "min_stats": {"stamina": 60}}},
            {"text": "éœ²æ¯”çš„é‚€è«‹ï¼š ã€Œæˆ‘çˆ¸åª½é€™é€±æœ«ä¸åœ¨å®¶ï¼Œä¾†æˆ‘å®¶æ‰“æ–°çš„ 3A å¤§ä½œï¼ä¸å‡†æ‹’çµ•ï¼Œæˆ‘æœ‰è²·ä½ æ„›åƒçš„ç‚¸é›žï¼ã€", "next_scene": "ending_ruby", "requirements": {"min_stats": {"appearance": 9}, "npcs": {"childhood_friend": {"min_affection": 30}}}},
            {"text": "Selina çš„é‚€è«‹ï¼š ã€Œæˆ‘å€‘å’–å•¡å»³é€™é€±æœ«æœ‰æ–°å“è©¦åƒæ´»å‹•ï¼Œç¼ºä¸€å€‹ã€Žè©¦åƒå“¡ã€ï¼Œæˆ‘è¦ºå¾—ä½ å¾ˆé©åˆï¼Œä¾†å¹«æˆ‘è©¦å‘³é“å¥½å—Žï¼Ÿã€", "next_scene": "ending_selina", "requirements": {"min_stats": {"wealth": 3000}, "player_flags": ["met_selina"]}}
        ]
    },

    # --- çµå±€ ---
    "ending_ziqi": {
        "text": "ðŸŒ¹ çµå±€ä¸€ï¼šåœ–æ›¸é¤¨çš„éœè¬é »çŽ‡ï¼ˆèˆžæ¢“çª ç¯‡ï¼‰\nã€é‚€è«‹ï¼šåœ¨æœŸä¸­è€ƒå¾Œçš„åœ–æ›¸é¤¨å°ç­”æ¡ˆã€‘\nç•¶æœ€å¾Œä¸€ç›žè‡ªä¿®å®¤çš„ç‡ˆç†„æ»…ï¼Œä½ èˆ‡èˆžæ¢“çªä¸¦è‚©èµ°å‡ºåœ–æ›¸é¤¨ã€‚æ ¡åœ’çš„æ™šé¢¨å¹æ•£äº†é€£æ—¥è€ƒè©¦çš„ç‡¥ç†±ã€‚\nã€Œå…¶å¯¦...ã€æ¢“çªåœä¸‹è…³æ­¥ï¼Œçœ‹è‘—æ•™å­¸å¤§æ¨“çš„ç‡ˆç«ï¼Œã€Œæˆ‘ä»¥å‰è¦ºå¾—é›»æ©Ÿç³»åªéœ€è¦é‚è¼¯å’Œå…¬å¼ã€‚ä½†é€™å¹¾é€±çœ‹åˆ°ä½ ï¼Œæ˜Žæ˜Žç´¯å¾—è¦å‘½ï¼Œå»é‚„èƒ½å …æŒä¸‹ä¾†ï¼Œç”šè‡³é‚„èƒ½å¹«æˆ‘ç¿»è­œ...ã€å¥¹å¾žæ›¸åŒ…è£¡æ‹¿å‡ºä¸€å¼µç²¾ç·»çš„éŸ³æ¨‚æœƒé–€ç¥¨ã€‚\nã€Œé€™æ˜¯é‹¼ç´ç¤¾çš„æœŸä¸­ç™¼è¡¨ï¼Œæˆ‘æœ‰ä¸€é¦–ç¨å¥ã€‚é›–ç„¶ä½ å¯èƒ½æ›´å–œæ­¡é›»è·¯åœ–ï¼Œä½†...æˆ‘å¸Œæœ›é‚£å¤©ä½ èƒ½ä¾†ã€‚ã€\n\nçµå±€è©•èªžï¼š ä½ ç”¨æ™ºæ…§èˆ‡è€å¿ƒæ•²é–‹äº†å†·æ„Ÿå­¸éœ¸çš„å¿ƒæ‰‰ã€‚æœªä¾†çš„å››å¹´ï¼Œé™¤äº†å†°å†·çš„èª²æœ¬ï¼Œä½ é‚„æ“æœ‰äº†é‹¼ç´çš„æ—‹å¾‹èˆ‡ä¸€ä½èƒ½èˆ‡ä½ ä¸¦è‚©ä½œæˆ°çš„éˆé­‚ä¼´ä¾¶ã€‚",
        "choices": []
    },
    "ending_panyu": {
        "text": "ðŸ çµå±€äºŒï¼šæŽ’çƒå ´ä¸Šçš„ä¸¦è‚©è·³èºï¼ˆå¦ç›¤çŽ‰ ç¯‡ï¼‰\nã€é‚€è«‹ï¼šé€ä»¶å¾Œçš„å®µå¤œæ…¶ç¥ã€‘\nåœ¨ä¸­åŽŸå¤œå¸‚çš„å–§é¬§è²ä¸­ï¼Œå¦ç›¤çŽ‰å’¬è‘—åœ°ç“œçƒï¼Œé–‹å¿ƒåœ°è·Ÿä½ æ“ŠæŽŒã€‚ã€Œå˜¿ï¼å‰›æ‰é«”è‚²çµ„è€å¸«èªªï¼Œæˆ‘å€‘çš„æ–°ç”Ÿç›ƒåå–®é€šéŽäº†ï¼ä½ æ˜¯æˆ‘å€‘ç­å”¯ä¸€çš„å…ˆç™¼ç”·çƒå“¡å–”ï¼ã€\nå¥¹çœ‹è‘—ä½ ï¼Œçœ¼ç¥žä¸­é–ƒçˆè‘—é‹å‹•å“¡ç‰¹æœ‰çš„ç†±æƒ…ã€‚ã€Œèªªå¯¦è©±ï¼Œå‰›é–‹å­¸æ™‚æˆ‘ä»¥ç‚ºä½ åªæ˜¯å€‹æœƒè®€æ›¸çš„å®…ç”·ï¼Œæ²’æƒ³åˆ°ä½ é«”åŠ›é€™éº¼å¥½ï¼ŒæŽ¥çƒä¹Ÿè¶Šä¾†è¶Šç©©äº†ã€‚ã€å¥¹çªç„¶æ¹Šè¿‘ï¼Œåœ¨ä½ è€³é‚Šè¼•è²èªªï¼šã€Œä»¥å¾Œçš„æ¯å ´æ¯”è³½ï¼Œä½ éƒ½è¦è² è²¬åœ¨å¾ŒæŽ’ç½©æˆ‘å–”ï¼Œæ‹æª”ï¼ã€\n\nçµå±€è©•èªžï¼š ä½ è­‰æ˜Žäº†é›»æ©Ÿç³»ç”·ç”Ÿä¹Ÿèƒ½æ“æœ‰é™½å…‰çš„é«”é­„ã€‚åœ¨å……æ»¿æ±—æ°´èˆ‡ç¬‘è²çš„æŽ’çƒå ´ä¸Šï¼Œä½ è´å¾—äº†å…¨ç³»æœ€æ´»æ½‘å¥³å­©çš„ä¿¡ä»»èˆ‡ä¾è³´ã€‚",
        "choices": []
    },
    "ending_ruby": {
        "text": "ðŸŽ® çµå±€ä¸‰ï¼šå¾žé’æ¢…ç«¹é¦¬åˆ°å”¯ä¸€çš„ä¾é ï¼ˆéœ²æ¯” ç¯‡ï¼‰\nã€é‚€è«‹ï¼šåŽ»éœ²æ¯”å®¶æ‰“ 3A å¤§ä½œã€‘\néŠæˆ²æ©Ÿçš„é¢¨æ‰‡å—¡å—¡ä½œéŸ¿ï¼Œéœ²æ¯”ç›¤è…¿ååœ¨æ²™ç™¼ä¸Šï¼Œå°ˆæ³¨åœ°ç›¯è‘—èž¢å¹•ã€‚ã€Œå¿«ï¼[ä¸»è§’å]ï¼é–‹å¤§æ‹›å•Šï¼ä½ è¦æ˜¯æŽ›äº†ï¼Œæˆ‘ä¹ŸçŽ©ä¸ä¸‹åŽ»å•¦ï¼ã€\næœ€çµ‚é­”çŽ‹å€’ä¸‹ï¼Œéœ²æ¯”èˆˆå¥®åœ°è½‰èº«æŠ±ä½ä½ ï¼Œéš¨å³åˆè‡‰ç´…åœ°æ”¾é–‹ã€‚ã€Œå’³...æ²’æƒ³åˆ°éš”äº†é€™éº¼å¤šå¹´ï¼Œæˆ‘å€‘é…åˆå¾—é‚„æ˜¯é€™éº¼å¥½ã€‚é›»æ©Ÿç³»çš„èª²çœŸçš„å¾ˆç´¯ï¼Œä½†æƒ³åˆ°æ¯å¤©é€²æ•™å®¤éƒ½èƒ½çœ‹åˆ°ä½ ååœ¨é‚£è£¡ï¼Œæˆ‘å°±è¦ºå¾—å¥½åƒä¹Ÿæ²’é‚£éº¼é›£ç†¬äº†ã€‚ã€å¥¹é åœ¨ä½ çš„è‚©é ­ï¼Œã€Œä»¥å¾Œ...ä¸å‡†å†è·Ÿæˆ‘å¤±åŽ»è¯ç¹«äº†ï¼ŒçŸ¥é“å—Žï¼Ÿã€\n\nçµå±€è©•èªžï¼š ç¹žäº†ä¸€å¤§åœˆï¼Œæœ€å¥½çš„å…¶å¯¦ä¸€ç›´åœ¨èº«é‚Šã€‚ä½ èˆ‡éœ²æ¯”åœ¨ç¹é‡çš„èª²æ¥­ä¸­æ‰¾åˆ°äº†å½¼æ­¤æœ€èˆ’æœçš„ç›¸è™•æ¨¡å¼ï¼Œé‚£æ˜¯èª°ä¹Ÿç„¡æ³•å–ä»£çš„é»˜å¥‘ã€‚",
        "choices": []
    },
    "ending_selina": {
        "text": "â˜• çµå±€å››ï¼šè·¨è¶Šç§‘ç³»çš„ç”œèœœé »çŽ‡ï¼ˆSelina ç¯‡ï¼‰\nã€é‚€è«‹ï¼šå’–å•¡å»³çš„ç”œé»žè©¦åƒå“¡ã€‘\næœ¨åŒ å’–å•¡å»³çš„ä¸€è§’ï¼ŒSelina ç·Šå¼µåœ°çœ‹è‘—ä½ åƒä¸‹å¥¹ç ”ç™¼çš„æ–°ç”¢å“ã€‚ã€Œæ€Žéº¼æ¨£ï¼Ÿæœƒå¤ªç”œå—Žï¼Ÿé€™æ˜¯æˆ‘ç‰¹åˆ¥ç‚ºäº†ã€Žå‹žç´¯çš„é›»æ©Ÿç³»å­¸ç”Ÿã€è¨­è¨ˆçš„è‰èŽ“èˆ’èŠ™è•¾å–”ï¼ã€\nçœ‹è‘—ä½ æ»¿æ„çš„è¡¨æƒ…ï¼Œå¥¹é–‹å¿ƒåœ°ç¬‘äº†ï¼Œæ‹¿å‡ºç´ ææœ¬è¿…é€Ÿåœ°ç•«ä¸‹ä½ åƒæ±è¥¿çš„æ¨£å­ã€‚ã€Œå•†è¨­ç³»çš„ä½œæ¥­çœŸçš„å¾ˆç…©ï¼Œä½†æ¯æ¬¡åœ¨åº—è£¡çœ‹åˆ°ä½ ï¼Œæˆ‘å°±è¦ºå¾—éˆæ„Ÿåˆå›žä¾†äº†ã€‚ä½ æ˜¯æˆ‘çš„å°ˆå±¬æ¨¡ç‰¹å…’ï¼Œä¹Ÿæ˜¯æˆ‘æœ€æ£’çš„é¿é¢¨æ¸¯ã€‚ã€å¥¹éžçµ¦ä½ ä¸€å¼µé›†é»žå¡ï¼Œä¸Šé¢å·²ç¶“è“‹æ»¿äº†å¿ƒå½¢å°ç« ï¼Œã€Œé€™å¼µå¡ï¼Œåªæœ‰ä½ èƒ½ç”¨ä¸€è¼©å­å–”ã€‚ã€\n\nçµå±€è©•èªžï¼š ä½ åœ¨ç†æ€§çš„é›»æ©Ÿä¸–ç•Œä¸­ï¼Œä¿ç•™äº†ä¸€ä»½æ„Ÿæ€§çš„æµªæ¼«ã€‚Selina çš„ç”œé»žèˆ‡è¨­è¨ˆæ„Ÿï¼Œç‚ºä½ åŽŸæœ¬å¯èƒ½æž¯ç‡¥çš„å¤§å­¸ç”Ÿæ´»æŠ¹ä¸Šäº†æœ€ç¹½ç´›çš„è‰²å½©ã€‚",
        "choices": []
    },

    "ending_sudden_death": {
        "text": "ã€éš±è—çµå±€ï¼šçŒæ­»ã€‘\nä½ æ„Ÿåˆ°ä¸€é™£å¤©æ—‹åœ°è½‰ï¼Œçœ¼å‰ç™¼é»‘ã€‚é€£çºŒçš„ç†¬å¤œã€ä¸è¦å¾‹çš„é£²é£Ÿã€ä»¥åŠç¹é‡çš„èª²æ¥­å£“åŠ›ï¼Œçµ‚æ–¼å£“åž®äº†ä½ çš„èº«é«”ã€‚åœ¨ä½ å¤±åŽ»æ„è­˜å‰çš„æœ€å¾Œä¸€åˆ»ï¼Œä½ å½·å½¿çœ‹åˆ°äº†å¤§å­¸éŒ„å–é€šçŸ¥æ›¸ï¼Œé‚£æ›¾ç¶“æ˜¯ä½ ä¸€åˆ‡å¤¢æƒ³çš„é–‹ç«¯... éŠæˆ²çµæŸã€‚",
        "choices": []
    },
 

    "final_ending": {"type": "final_eval"},
    "ending_perfect": {"text": "çµå±€ï¼šå®Œç¾Žäººç”Ÿ..."},
    "ending_love_lost_friend": {"text": "çµå±€ï¼šéºå¤±çš„å‹æƒ…..."},
    "ending_scholar": {"text": "çµå±€ï¼šå­¤é«˜çš„å­¸è€…..."},
}

# --- è§’è‰²å‰µå»º ---
def character_creation():
    stats = {"wealth": 2000, "intelligence": 3, "appearance": 3, "height": 160}
    points = random.randint(8, 13)
    stat_names = {"1": "appearance", "2": "wealth", "3": "intelligence", "4": "height"}
    stat_display_names = {"appearance": "é¡å€¼", "wealth": "è²¡å¯Œ", "intelligence": "æ™ºæ…§", "height": "èº«é«˜"}
    
    while True:
        os.system('cls' if os.name == 'nt' else 'clear')
        term_width = os.get_terminal_size().columns
        
        title = "å‰µå»ºä½ çš„è§’è‰²"
        lines = [f"ä½ å…±æœ‰ {colors['system']}{points}{Style.RESET_ALL} é»žå¯ä»¥åˆ†é…ã€‚"]
        lines.append("-" * 10)
        for key, name in stat_display_names.items():
            unit = ''
            if key == 'height':
                unit = 'cm'
            elif key == 'wealth':
                unit = 'å…ƒ'
            lines.append(f"{name}: {stats[key]}{unit}")
        lines.append("-" * 10)
        lines.append("å¢žåŠ å±¬æ€§ï¼š")
        lines.append(f"  {colors['prompt']}1. é¡å€¼ (+1){Style.RESET_ALL}    {colors['prompt']}2. è²¡å¯Œ (+500å…ƒ){Style.RESET_ALL}")
        lines.append(f"  {colors['prompt']}3. æ™ºæ…§ (+1){Style.RESET_ALL}    {colors['prompt']}4. èº«é«˜ (+5cm){Style.RESET_ALL}")
        lines.append("æ¸›å°‘å±¬æ€§ï¼š")
        lines.append(f"  {colors['prompt']}5. é¡å€¼ (-1){Style.RESET_ALL}    {colors['prompt']}6. è²¡å¯Œ (-500å…ƒ){Style.RESET_ALL}")
        lines.append(f"  {colors['prompt']}7. æ™ºæ…§ (-1){Style.RESET_ALL}    {colors['prompt']}8. èº«é«˜ (-5cm){Style.RESET_ALL}")
        lines.append("-" * 10)
        lines.append(f"{colors['system']}C. å®Œæˆå‰µå»º{Style.RESET_ALL}")
        
        draw_box(title, lines, term_width)
        
        choice = input(colors["prompt"] + "> " + Style.RESET_ALL).lower()
        
        if choice == 'c':
            if points >= 0: break
        
        if choice in ['1', '2', '3', '4']: # Add points
            if points > 0:
                stat_to_change = stat_names[choice]
                if stat_to_change == 'height':
                    stats[stat_to_change] += 5
                elif stat_to_change == 'wealth':
                    stats[stat_to_change] += 500
                else:
                    stats[stat_to_change] += 1
                points -= 1
        elif choice in ['5', '6', '7', '8']: # Subtract points
            stat_to_change = {"5": "appearance", "6": "wealth", "7": "intelligence", "8": "height"}[choice]
            min_value = 1
            if stat_to_change == 'height':
                min_value = 165
            elif stat_to_change == 'wealth':
                min_value = 500 # Or some other minimum
            
            if stats[stat_to_change] > min_value:
                if stat_to_change == 'height':
                    stats[stat_to_change] -= 5
                elif stat_to_change == 'wealth':
                    stats[stat_to_change] -= 500
                else:
                    stats[stat_to_change] -= 1
                points += 1
    
    final_stats = {"inventory": [], "stamina": 100, "max_stamina": 100, "flags": []}
    final_stats.update(stats)
    return final_stats

# --- éŠæˆ²ä¸»å¼•æ“Ž ---
def main():
    global player_stats, npc_stats, time_stats
    init(autoreset=True)
    try: sys.stdout.reconfigure(encoding='utf-8') # å¼·åˆ¶è¨­å®šè¼¸å‡ºç·¨ç¢¼
    except: pass
    
    current_scene_id = "game_intro"
    info_message = ""
    loaded_game = False
    if os.path.exists(SAVE_FILE):
        if input(colors["system"] + "æ˜¯å¦è®€å–ä¹‹å‰çš„å­˜æª”ï¼Ÿ(y/n): " + Style.RESET_ALL).lower() == 'y':
            p, n, t, c = load_game()
            if p: 
                player_stats, npc_stats, time_stats, current_scene_id = p, n, t, c
                info_message = "è®€å–æˆåŠŸï¼"
                loaded_game = True
            else:
                info_message = "è®€å–å¤±æ•—ï¼å°‡é–‹å§‹æ–°éŠæˆ²ã€‚"
    
    if not loaded_game:
        display_girl_profiles() # é¡¯ç¤ºå¥³ä¸»è§’è¨­å®š
        player_stats = character_creation()

    term_width = os.get_terminal_size().columns

    while True:
        os.system('cls' if os.name == 'nt' else 'clear')

        scene = story.get(current_scene_id)
        if not scene: print(f"éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å ´æ™¯ {current_scene_id}ï¼"); break
        
        scene_type = scene.get("type")
        if scene_type == "router":
            next_scene_found = False
            for route in scene["routes"]:
                conditions_met = True
                conds = route["conditions"]

                if "npcs" in conds:
                    for npc_name, reqs in conds["npcs"].items():
                        if "min_affection" in reqs and npc_stats[npc_name]["affection"] < reqs["min_affection"]:
                            conditions_met = False
                            break
                if not conditions_met:
                    continue

                if "player_flags" in conds:
                    if not all(flag in player_stats["flags"] for flag in conds["player_flags"]):
                        conditions_met = False
                if not conditions_met:
                    continue

                if "min_stats" in conds:
                    for stat, value in conds["min_stats"].items():
                        if player_stats.get(stat, 0) < value:
                            conditions_met = False
                            break
                if not conditions_met:
                    continue

                if "random_chance" in conds:
                    if random.random() >= conds["random_chance"]:
                        conditions_met = False
                if not conditions_met:
                    continue
                
                # If all conditions passed
                if conditions_met:
                    current_scene_id = route["scene"]
                    next_scene_found = True
                    break
            
            if not next_scene_found:
                current_scene_id = scene["routes"][-1]["scene"]
            continue
        if scene_type == "final_eval":
            if npc_stats["top_student_girl"]["affection"] >= 15 and npc_stats["friend"]["affection"] > 0: current_scene_id = "ending_perfect"
            elif npc_stats["top_student_girl"]["affection"] >= 15 and npc_stats["friend"]["affection"] <= 0: current_scene_id = "ending_love_lost_friend"
            else: current_scene_id = "ending_scholar"
            continue
        if scene_type == "event_trigger":
            if scene["event_type"] == "exam":
                current_scene_id = scene["pass_scene"] if player_stats["intelligence"] >= scene["pass_threshold"] else scene["fail_scene"]
                continue

        day_of_week = DAYS_OF_WEEK[time_stats['day_of_week_index']]
        time_str = f"ðŸ“… ç¬¬ {time_stats['week']} é€±, æ˜ŸæœŸ{day_of_week}, {PERIODS[time_stats['period_index']]}"
        draw_box("æˆ€æ„›æ¨¡æ“¬å™¨", [time_str], term_width)
        state_lines = prepare_state_lines(player_stats, npc_stats)
        draw_box("ç‹€æ…‹", state_lines, term_width)
        if info_message: draw_box("é€šçŸ¥", textwrap.wrap(info_message, width=int((term_width - 8)/2)), term_width); info_message = ""
        scene_lines = textwrap.wrap(scene["text"], width=int((term_width - 8)/2)) # ç¸®æ¸›å¯¬åº¦ä»¥å®¹ç´ä¸­æ–‡å­—
        draw_box("åŠ‡æƒ…", scene_lines, term_width)

        if "choices" not in scene or not scene["choices"]: print("éŠæˆ²çµæŸã€‚"); break
        
        while True:
            choice_map = {} # Map visible choice number to the actual choice object
            choice_lines = [] # Initialize choice_lines
            visible_choice_num = 1
            for choice_index, choice in enumerate(scene["choices"]): # Iterate through all choices, original order
                reqs = choice.get("requirements", {})
                can_choose = True
                locked_message_parts = []

                for stat, value in reqs.get("min_stats", {}).items():
                    if player_stats.get(stat, 0) < value:
                        can_choose = False
                        # Display stat names in Chinese
                        stat_display_name = {"stamina": "é«”åŠ›", "intelligence": "æ™ºæ…§", "appearance": "é¡å€¼", "height": "èº«é«˜", "wealth": "è²¡å¯Œ"}.get(stat, stat)
                        locked_message_parts.append(f"éœ€è¦ {stat_display_name} >= {value}")
                for stat, value in reqs.get("max_stats", {}).items():
                    if player_stats.get(stat, 0) > value:
                        can_choose = False
                        stat_display_name = {"stamina": "é«”åŠ›", "intelligence": "æ™ºæ…§", "appearance": "é¡å€¼", "height": "èº«é«˜", "wealth": "è²¡å¯Œ"}.get(stat, stat)
                        locked_message_parts.append(f"éœ€è¦ {stat_display_name} <= {value}")
                for npc_key, req in reqs.get("npcs", {}).items():
                    for req_type, value in req.items():
                        if req_type == "min_affection" and npc_stats[npc_key]["affection"] < value:
                            can_choose = False
                            # Use girl's display name for better UX
                            girl_name = next((g['name'] for g in GIRL_PROFILES if g['key'] == npc_key), npc_key)
                            locked_message_parts.append(f"éœ€è¦ {girl_name} å¥½æ„Ÿåº¦: {value}")

                if can_choose:
                    choice_lines.append(f"{colors['prompt']}{visible_choice_num}. {choice['text']}{Style.RESET_ALL}")
                    choice_map[visible_choice_num] = choice
                else:
                    locked_reason = ", ".join(locked_message_parts) if locked_message_parts else "æ¢ä»¶ä¸è¶³"
                    choice_lines.append(f"{colors['locked']}{visible_choice_num}. {choice['text']} ({locked_reason}){Style.RESET_ALL}")
                visible_choice_num += 1

            choice_lines.append(colors["system"] + "---"); choice_lines.append(colors["system"] + "S.å„²å­˜ / L.è®€å–")
            draw_box("é¸æ“‡", choice_lines, term_width)
            player_input = input(colors["prompt"] + "> " + Style.RESET_ALL).lower()

            if player_input == 's': save_game(player_stats, npc_stats, time_stats, current_scene_id); info_message = "éŠæˆ²å·²å„²å­˜ï¼"; break
            if player_input == 'l':
                p, n, t, c = load_game();
                if p: player_stats, npc_stats, time_stats, current_scene_id = p, n, t, c; info_message = "è®€å–æˆåŠŸï¼"; break
                else: info_message = "è®€å–å¤±æ•—ï¼"; continue
            try:
                choice_num = int(player_input);
                if choice_num in choice_map: # Check if the entered number maps to an available choice
                    chosen_option = choice_map[choice_num]
                    break
                else:
                    info_message = "ç„¡æ•ˆçš„é¸é …æˆ–è©²é¸é …ç›®å‰ç„¡æ³•é¸æ“‡ã€‚"
            except ValueError:
                info_message = "è«‹è¼¸å…¥æ•¸å­—æˆ– S/L"

        if info_message: continue

        effects = chosen_option.get("effects", {})
        for stat, value in effects.get("player", {}).items():
            if stat == 'stamina':
                player_stats[stat] = min(player_stats.get('max_stamina', 100), player_stats.get(stat, 0) + value)
            else:
                player_stats[stat] = player_stats.get(stat, 0) + value
            info_message += f"[{stat} {'+' if value > 0 else ''}{value}] "
        
        if player_stats.get('stamina', 0) <= 0:
            current_scene_id = 'ending_sudden_death'
            continue

        for npc, stats in effects.get("npcs", {}).items():
            for stat, value in stats.items():
                npc_stats[npc][stat] += value
                if stat == "affection": info_message += f"[{npc} å¥½æ„Ÿåº¦ {'+' if value > 0 else ''}{value}] "
        for flag in effects.get("add_flags", []):
            if flag not in player_stats["flags"]:
                player_stats["flags"].append(flag)
        for flag in effects.get("remove_flags", []):
            if flag in player_stats["flags"]:
                player_stats["flags"].remove(flag)
        
        next_scene = chosen_option.get("next_scene")

        next_scene = chosen_option.get("next_scene")

        # Advance time period unless the scene was timeless
        if not scene.get("no_time_cost"):
            time_stats["period_index"] += 1
        
        # If the next scene would be the removed daily_router, or if the day has ended,
        # we need to find the next scheduled event.
        if next_scene == "daily_router" or time_stats["period_index"] >= len(PERIODS):
            
            # If period rolled over, reset to morning for the *new* day.
            # If daily_router, it means we are effectively ending current day and moving to next.
            time_stats["period_index"] = 0 
            
            # Advance to the "next" calendar day. This is the first day we will check for an event.
            time_stats["day_of_week_index"] += 1
            if time_stats["day_of_week_index"] >= len(DAYS_OF_WEEK):
                time_stats["day_of_week_index"] = 0
                time_stats["week"] += 1

            plot_days_passed = 0 # This will count the number of "plot days" until the next event

            # Loop to find the next event day
            while True:
                if time_stats["week"] > 6:  # End of the game condition
                    current_scene_id = "final_ending"
                    break

                event_key = f"W{time_stats['week']}_D{time_stats['day_of_week_index']}"
                
                # Check for event on the *current calendar day*
                if event_key in scheduled_events:
                    # If this is a scheduled event day, increment plot_days_passed.
                    plot_days_passed += 1 
                    current_scene_id = scheduled_events[event_key]
                    break # Found the next event day

                # If no event on this calendar day, just advance to the next calendar day
                time_stats["day_of_week_index"] += 1
                if time_stats["day_of_week_index"] >= len(DAYS_OF_WEEK):
                    time_stats["day_of_week_index"] = 0
                    time_stats["week"] += 1
            
            # Apply stamina recovery based on plot_days_passed
            total_recovery = plot_days_passed * STAMINA_RECOVERY_ON_SLEEP
            player_stats["stamina"] = min(player_stats.get("max_stamina", 100), player_stats.get("stamina", 0) + total_recovery)
            
            if plot_days_passed > 0:
                info_message += f"æ™‚é–“å¿«é€Ÿæµé€äº† {plot_days_passed} å¤©ï¼Œé«”åŠ›æ¢å¾©äº† {total_recovery} é»žï¼"
            
            continue # Restart the main loop to process the new scene
        
        else:  # Normal transition on the same day to a specific scene
            current_scene_id = next_scene

if __name__ == "__main__":
    try: main()
    except KeyboardInterrupt: print("\n\néŠæˆ²å·²ä¸­æ–·ã€‚"); sys.exit(0)
    except Exception as e: print(f"\n\nç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤: {e}"); import traceback; traceback.print_exc()
